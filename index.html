<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArKasir - POS Mobile</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- HTML2Canvas for PNG export (Struk & Laporan) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Chart.js for Reports -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fc; }
        /* Style for mobile-first container */
        #app-container {
            max-width: 420px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            background-color: #ffffff;
        }
        /* Custom scrollbar for better mobile feel */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 2px; }
        .tab-button.active { background-color: #3b82f6; color: white; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .input-style { border-radius: 0.5rem; padding: 0.75rem; border: 1px solid #d1d5db; width: 100%; }
        /* Style for the receipt preview/export area */
        #receipt-content {
            background-color: white;
            padding: 20px;
            font-family: monospace;
            font-size: 10px;
            width: 300px; /* Standard receipt width */
            max-width: 100%;
        }
        /* Hidden input for file operations */
        .file-input { display: none; }
        /* PWA Status Bar Color for Mobile */
        [data-theme-color] {
            color: var(--theme-color);
        }
    </style>
    <meta name="theme-color" content="#3b82f6">
</head>
<body class="p-0 m-0">
    <div id="app-container">
        <!-- Header & Nav Tabs -->
        <header class="p-4 bg-blue-600 text-white rounded-b-xl shadow-lg flex justify-between items-center sticky top-0 z-10">
            <h1 class="text-xl font-bold">ArKasir</h1>
            <button id="pwa-install-button" class="bg-blue-800 text-xs px-3 py-1 rounded-full hidden" title="Instal Aplikasi (PWA)">
                Instal
            </button>
        </header>

        <!-- Main Content Area -->
        <main class="flex-grow overflow-y-auto p-4 pb-20">
            <div id="kasir-view" class="view"></div>
            <div id="laporan-view" class="view hidden"></div>
            <div id="keuangan-view" class="view hidden"></div>
            <div id="pengaturan-view" class="view hidden"></div>
        </main>

        <!-- Bottom Navigation Bar -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-xl max-w-[420px] mx-auto z-20 rounded-t-xl">
            <div class="flex justify-around items-center h-16">
                <button data-view="kasir-view" class="tab-button active flex flex-col items-center p-2 rounded-lg text-sm transition duration-150">
                    <i data-lucide="scan-line" class="w-5 h-5"></i>
                    Kasir
                </button>
                <button data-view="laporan-view" class="tab-button flex flex-col items-center p-2 rounded-lg text-sm transition duration-150">
                    <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                    Laporan
                </button>
                <button data-view="keuangan-view" class="tab-button flex flex-col items-center p-2 rounded-lg text-sm transition duration-150">
                    <i data-lucide="wallet" class="w-5 h-5"></i>
                    Keuangan
                </button>
                <button data-view="pengaturan-view" class="tab-button flex flex-col items-center p-2 rounded-lg text-sm transition duration-150">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                    Pengaturan
                </button>
            </div>
        </nav>
    </div>

    <!-- Modal Container for Receipt/Alerts -->
    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <!-- Modal content will be injected here -->
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, orderBy, writeBatch, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ====================================================================
        // 1. FIREBASE & AUTHENTICATION SETUP
        // ====================================================================

        setLogLevel('Debug');
        let db;
        let auth;
        let userId = 'default-user'; // Default for initialization
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let isAuthReady = false;

        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Authentication Process
            const authenticateUser = async () => {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with custom token.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously.");
                    }
                } catch (error) {
                    console.error("Authentication Error:", error);
                    // Fallback to anonymous if custom token fails
                    try {
                        await signInAnonymously(auth);
                    } catch (e) {
                        console.error("Anonymous Sign-in Failed:", e);
                    }
                }
            };

            // Listen for auth state changes
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("User ID:", userId);
                } else {
                    userId = 'anonymous-' + crypto.randomUUID();
                    console.log("Anonymous User ID:", userId);
                }
                isAuthReady = true;
                // Once authenticated, initialize data listeners
                initializeDataListeners();
            });

            authenticateUser();

        } else {
            console.error("Firebase config is missing. Application will run in simulated mode without persistence.");
            isAuthReady = true;
            initializeDataListeners(); // Run listeners even without Firebase (they will use local data)
        }

        // ====================================================================
        // 2. STATE AND UTILITIES
        // ====================================================================

        const state = {
            products: [],
            cart: [],
            transactions: [],
            financeLog: [],
            settings: {
                storeName: 'ArKasir Toko Saya',
                cashierName: 'Kasir Default',
                address: 'Jl. Utama No. 1, Kota Anda',
                logoUrl: 'https://placehold.co/100x100/3b82f6/ffffff?text=LOGO'
            },
            currentView: 'kasir-view',
            // For Reporting
            reportData: {
                daily: { date: new Date().toISOString().split('T')[0], total: 0, count: 0 },
                weekly: { total: 0, count: 0 },
                monthly: { total: 0, count: 0 },
            },
            userIdDisplay: userId,
        };

        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
        };

        const formatDate = (timestamp) => {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' });
        };

        const showMessage = (title, message, isError = false) => {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = `
                <div class="bg-white p-6 rounded-lg w-full max-w-sm card-shadow transform transition-all duration-300">
                    <h3 class="text-xl font-bold mb-3 ${isError ? 'text-red-600' : 'text-blue-600'}">${title}</h3>
                    <p class="text-gray-700 mb-4">${message}</p>
                    <button id="modal-close" class="bg-blue-600 text-white w-full py-2 rounded-lg hover:bg-blue-700 transition">Tutup</button>
                </div>
            `;
            modalContainer.classList.remove('hidden');
            document.getElementById('modal-close').onclick = () => modalContainer.classList.add('hidden');
        };

        // ====================================================================
        // 3. FIRESTORE PATHS & OPERATIONS
        // ====================================================================

        const getPublicCollectionRef = (collectionName) => {
            if (!db) return null;
            return collection(db, `artifacts/${appId}/public/data/${collectionName}`);
        };

        const getPrivateDocRef = (collectionName, docId) => {
            if (!db) return null;
            return doc(db, `artifacts/${appId}/users/${userId}/${collectionName}`, docId);
        };
        
        const getPrivateCollectionRef = (collectionName) => {
            if (!db) return null;
            return collection(db, `artifacts/${appId}/users/${userId}/${collectionName}`);
        };


        // ====================================================================
        // 4. DATA LISTENERS (Firestore Real-time)
        // ====================================================================

        const initializeDataListeners = () => {
            if (!isAuthReady) return;

            // 4.1. Listen to Products
            if (db) {
                const productsRef = getPublicCollectionRef('products');
                onSnapshot(productsRef, (snapshot) => {
                    state.products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderKasirView();
                    renderSettingsView(); // Refresh settings if product management is needed
                }, (error) => {
                    console.error("Error listening to products:", error);
                });

                // 4.2. Listen to Transactions
                const transactionsRef = getPublicCollectionRef('transactions');
                const transactionsQuery = query(transactionsRef, orderBy('timestamp', 'desc'));
                onSnapshot(transactionsQuery, (snapshot) => {
                    state.transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    calculateReports();
                    renderLaporanView();
                }, (error) => {
                    console.error("Error listening to transactions:", error);
                });
                
                // 4.3. Listen to Finance Log (Pemasukan/Pengeluaran Non-Kasir)
                const financeLogRef = getPrivateCollectionRef('finance_log');
                const financeQuery = query(financeLogRef, orderBy('timestamp', 'desc'));
                onSnapshot(financeQuery, (snapshot) => {
                    state.financeLog = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderKeuanganView();
                }, (error) => {
                    console.error("Error listening to finance log:", error);
                });

                // 4.4. Listen to Settings (single document)
                const settingsRef = getPrivateDocRef('settings', 'store_config');
                onSnapshot(settingsRef, (doc) => {
                    if (doc.exists()) {
                        state.settings = { ...state.settings, ...doc.data() };
                    }
                    renderSettingsView();
                    renderKasirView(); // To update cashier name/store name
                }, (error) => {
                    console.error("Error listening to settings:", error);
                });
            }

            // Initial render
            renderKasirView();
            renderSettingsView();
            renderKeuanganView();
        };

        // ====================================================================
        // 5. VIEW RENDERING FUNCTIONS
        // ====================================================================

        // 5.1. Kasir View (Main POS)
        const renderKasirView = () => {
            const container = document.getElementById('kasir-view');
            
            const subtotal = state.cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            const totalItems = state.cart.reduce((sum, item) => sum + item.qty, 0);

            container.innerHTML = `
                <div class="flex items-center space-x-2 mb-4 bg-yellow-100 p-3 rounded-lg border border-yellow-300">
                    <i data-lucide="user" class="w-5 h-5 text-yellow-600"></i>
                    <span class="text-sm font-medium text-gray-700">
                        Kasir: ${state.settings.cashierName} | ID Anda: <span id="user-id-display" class="font-mono text-xs text-yellow-800 break-all">${userId}</span>
                    </span>
                </div>
                
                <!-- Search/Barcode Input -->
                <div class="mb-4">
                    <div class="relative">
                        <input type="text" id="barcode-input" placeholder="Scan/Input Barcode atau Nama Produk" class="input-style pr-10 focus:ring-blue-500 focus:border-blue-500" onkeydown="if(event.key === 'Enter') handleBarcodeScan(this.value); this.value=''" autofocus>
                        <i data-lucide="scan" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"></i>
                    </div>
                </div>

                <!-- Product List (Quick Access) -->
                <h3 class="font-semibold text-lg mb-2 text-gray-700">Produk Tersedia</h3>
                <div class="grid grid-cols-2 gap-3 mb-6 max-h-48 overflow-y-auto p-2 border rounded-lg bg-gray-50">
                    ${state.products.length > 0 ? state.products.map(p => `
                        <button onclick="addToCart('${p.id}')" class="bg-white p-3 rounded-lg border text-left hover:bg-blue-50 transition duration-150 shadow-sm">
                            <p class="font-medium text-sm text-blue-800">${p.name}</p>
                            <p class="text-xs text-gray-500">${formatCurrency(p.price)}</p>
                        </button>
                    `).join('') : '<p class="text-gray-500 text-sm col-span-2 text-center py-4">Belum ada produk. Tambahkan di Pengaturan.</p>'}
                </div>

                <!-- Cart Summary -->
                <div class="bg-blue-50 p-4 rounded-xl card-shadow">
                    <h3 class="font-semibold text-xl mb-3 flex justify-between items-center text-blue-800">
                        Keranjang <span class="text-sm text-blue-600">(${totalItems} item)</span>
                    </h3>
                    <div class="space-y-3 max-h-40 overflow-y-auto mb-3 pr-2">
                        ${state.cart.length > 0 ? state.cart.map(item => `
                            <div class="flex justify-between items-center text-sm border-b pb-2">
                                <div class="flex-1 min-w-0 pr-2">
                                    <p class="font-medium truncate">${item.name}</p>
                                    <p class="text-xs text-gray-500">${formatCurrency(item.price)} x ${item.qty}</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button onclick="updateCartQty('${item.id}', -1)" class="text-red-500 hover:text-red-700 text-lg font-bold w-6 h-6 rounded-full border">-</button>
                                    <span class="font-bold w-4 text-center">${item.qty}</span>
                                    <button onclick="updateCartQty('${item.id}', 1)" class="text-green-500 hover:text-green-700 text-lg font-bold w-6 h-6 rounded-full border">+</button>
                                </div>
                                <span class="w-20 text-right font-semibold">${formatCurrency(item.price * item.qty)}</span>
                            </div>
                        `).join('') : '<p class="text-center text-gray-500 py-4">Keranjang kosong. Tambahkan produk!</p>'}
                    </div>
                    
                    <div class="border-t pt-3 mt-3">
                        <div class="flex justify-between items-center text-2xl font-extrabold text-blue-900">
                            <span>TOTAL</span>
                            <span>${formatCurrency(subtotal)}</span>
                        </div>
                    </div>
                    
                    <button onclick="handleCheckout(${subtotal})" ${state.cart.length === 0 ? 'disabled' : ''} class="mt-4 w-full bg-green-500 text-white py-3 rounded-lg text-lg font-bold hover:bg-green-600 transition disabled:opacity-50 disabled:cursor-not-allowed">
                        <i data-lucide="hand-coins" class="inline w-5 h-5 mr-2"></i>
                        Bayar Sekarang
                    </button>
                </div>
            `;
            lucide.createIcons(); // Re-render Lucide icons
        };

        // 5.2. Laporan View
        let reportChartInstance = null;
        const renderLaporanView = () => {
            const container = document.getElementById('laporan-view');
            const { daily, weekly, monthly } = state.reportData;
            
            // Analyze data (Simple analysis)
            const totalRevenue = monthly.total;
            const avgTransaction = monthly.count > 0 ? totalRevenue / monthly.count : 0;
            const avgDailyRevenue = totalRevenue / 30;

            // Chart Data (Last 7 days)
            const last7Days = generateLast7DaysData(state.transactions);

            container.innerHTML = `
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Laporan Penjualan</h2>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-blue-100 p-4 rounded-xl border border-blue-300">
                        <p class="text-sm text-blue-700 font-medium">Total Harian (${daily.date})</p>
                        <p class="text-xl font-bold text-blue-900">${formatCurrency(daily.total)}</p>
                        <p class="text-xs text-gray-600">${daily.count} Transaksi</p>
                    </div>
                    <div class="bg-green-100 p-4 rounded-xl border border-green-300">
                        <p class="text-sm text-green-700 font-medium">Total Bulanan</p>
                        <p class="text-xl font-bold text-green-900">${formatCurrency(monthly.total)}</p>
                        <p class="text-xs text-gray-600">${monthly.count} Transaksi</p>
                    </div>
                </div>

                <!-- Analisa & Detail -->
                <div class="bg-white p-4 rounded-xl card-shadow mb-6">
                    <h3 class="font-semibold text-lg mb-2 text-gray-700 flex items-center">
                        <i data-lucide="trending-up" class="w-5 h-5 mr-2 text-indigo-600"></i>
                        Analisa Singkat
                    </h3>
                    <ul class="text-sm space-y-1 text-gray-600">
                        <li>- Rata-rata Nilai Transaksi: <span class="font-bold text-indigo-700">${formatCurrency(avgTransaction)}</span></li>
                        <li>- Estimasi Pendapatan Harian: <span class="font-bold text-indigo-700">${formatCurrency(avgDailyRevenue)}</span></li>
                        <li>- Transaksi terakhir: ${state.transactions.length > 0 ? formatDate(state.transactions[0].timestamp) : 'N/A'}</li>
                    </ul>
                </div>
                [attachment_0](attachment)

                <!-- Chart Area -->
                <div id="report-chart-area" class="bg-white p-4 rounded-xl card-shadow mb-6">
                    <h3 class="font-semibold text-lg mb-3 text-gray-700">Grafik 7 Hari Terakhir</h3>
                    <canvas id="salesChart"></canvas>
                </div>
                
                <!-- Export Button -->
                <button onclick="exportReportToPNG()" class="w-full bg-indigo-500 text-white py-3 rounded-lg text-lg font-bold hover:bg-indigo-600 transition">
                    <i data-lucide="download" class="inline w-5 h-5 mr-2"></i>
                    Unduh Laporan (PNG)
                </button>
            `;
            lucide.createIcons();
            
            // Render Chart
            renderChart(last7Days);
        };

        // 5.3. Keuangan View (Pemasukan & Pengeluaran Non-Kasir)
        const renderKeuanganView = () => {
            const container = document.getElementById('keuangan-view');
            const totalIn = state.financeLog.filter(f => f.type === 'in').reduce((sum, f) => sum + f.amount, 0);
            const totalOut = state.financeLog.filter(f => f.type === 'out').reduce((sum, f) => sum + f.amount, 0);
            
            container.innerHTML = `
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Keuangan Non-Kasir</h2>
                
                <!-- Summary Card -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-green-50 p-4 rounded-xl border border-green-300">
                        <p class="text-sm text-green-700 font-medium">Total Pemasukan</p>
                        <p class="text-xl font-bold text-green-800">${formatCurrency(totalIn)}</p>
                    </div>
                    <div class="bg-red-50 p-4 rounded-xl border border-red-300">
                        <p class="text-sm text-red-700 font-medium">Total Pengeluaran</p>
                        <p class="text-xl font-bold text-red-800">${formatCurrency(totalOut)}</p>
                    </div>
                </div>

                <!-- Input Form -->
                <div class="bg-white p-4 rounded-xl card-shadow mb-6">
                    <h3 class="font-semibold text-lg mb-3 text-gray-700">Catat Pemasukan/Pengeluaran</h3>
                    <select id="finance-type" class="input-style mb-3">
                        <option value="in">Pemasukan (Misal: Modal Tambahan)</option>
                        <option value="out">Pengeluaran (Misal: Beli Alat Tulis)</option>
                    </select>
                    <input type="number" id="finance-amount" placeholder="Jumlah (IDR)" class="input-style mb-3">
                    <input type="text" id="finance-desc" placeholder="Keterangan" class="input-style mb-3">
                    <button onclick="addFinanceLog()" class="w-full bg-purple-500 text-white py-2 rounded-lg font-bold hover:bg-purple-600 transition">
                        <i data-lucide="plus" class="inline w-5 h-5 mr-2"></i>
                        Catat Keuangan
                    </button>
                </div>

                <!-- Log History -->
                <h3 class="font-semibold text-lg mb-3 text-gray-700">Riwayat Keuangan (${state.financeLog.length} catatan)</h3>
                <div class="space-y-3 max-h-64 overflow-y-auto pr-1">
                    ${state.financeLog.length > 0 ? state.financeLog.map(f => `
                        <div class="flex justify-between items-center p-3 rounded-lg ${f.type === 'in' ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'} border">
                            <div class="flex-1 min-w-0 pr-2">
                                <p class="font-medium truncate">${f.description}</p>
                                <p class="text-xs text-gray-500">${formatDate(f.timestamp)}</p>
                            </div>
                            <span class="font-bold ${f.type === 'in' ? 'text-green-600' : 'text-red-600'} text-right">
                                ${f.type === 'in' ? '+' : '-'} ${formatCurrency(f.amount)}
                            </span>
                        </div>
                    `).join('') : '<p class="text-center text-gray-500 py-4">Belum ada catatan keuangan.</p>'}
                </div>
            `;
            lucide.createIcons();
        };

        // 5.4. Pengaturan View
        const renderSettingsView = () => {
            const container = document.getElementById('pengaturan-view');
            const { storeName, cashierName, address, logoUrl } = state.settings;
            
            container.innerHTML = `
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Pengaturan & Manajemen</h2>
                
                <!-- Store Info Settings -->
                <div class="bg-white p-4 rounded-xl card-shadow mb-6">
                    <h3 class="font-semibold text-lg mb-3 text-gray-700 flex items-center">
                        <i data-lucide="store" class="w-5 h-5 mr-2 text-blue-600"></i>
                        Informasi Toko & Kasir
                    </h3>
                    
                    <div class="flex items-center space-x-4 mb-4">
                        <img src="${logoUrl}" onerror="this.onerror=null; this.src='https://placehold.co/100x100/3b82f6/ffffff?text=LOGO'" alt="Logo Toko" class="w-16 h-16 rounded-full object-cover border-2 border-blue-300">
                        <div>
                            <p class="text-sm text-gray-500">Logo Toko (Klik untuk Ubah)</p>
                            <input type="file" id="logo-upload" accept="image/*" class="file-input" onchange="previewLogo(event)">
                            <button onclick="document.getElementById('logo-upload').click()" class="text-blue-500 text-sm hover:text-blue-700">Ubah Logo</button>
                        </div>
                    </div>

                    <input type="text" id="setting-storeName" value="${storeName}" placeholder="Nama Toko" class="input-style mb-3">
                    <input type="text" id="setting-cashierName" value="${cashierName}" placeholder="Nama Kasir" class="input-style mb-3">
                    <textarea id="setting-address" placeholder="Alamat Toko" class="input-style mb-4 h-20">${address}</textarea>
                    
                    <button onclick="saveSettings()" class="w-full bg-blue-500 text-white py-2 rounded-lg font-bold hover:bg-blue-600 transition">
                        <i data-lucide="save" class="inline w-5 h-5 mr-2"></i>
                        Simpan Pengaturan
                    </button>
                </div>

                <!-- Product Management -->
                <div class="bg-white p-4 rounded-xl card-shadow mb-6">
                    <h3 class="font-semibold text-lg mb-3 text-gray-700 flex items-center">
                        <i data-lucide="package" class="w-5 h-5 mr-2 text-green-600"></i>
                        Manajemen Produk (${state.products.length})
                    </h3>
                    <input type="text" id="new-product-name" placeholder="Nama Produk" class="input-style mb-2">
                    <input type="text" id="new-product-barcode" placeholder="Barcode (Angka)" class="input-style mb-2">
                    <input type="number" id="new-product-price" placeholder="Harga (IDR)" class="input-style mb-3">
                    <button onclick="addProduct()" class="w-full bg-green-500 text-white py-2 rounded-lg font-bold hover:bg-green-600 transition mb-4">
                        <i data-lucide="plus" class="inline w-5 h-5 mr-2"></i>
                        Tambah Produk
                    </button>

                    <div class="max-h-32 overflow-y-auto space-y-2 pr-1 border-t pt-3">
                        ${state.products.map(p => `
                            <div class="flex justify-between items-center text-sm p-2 bg-gray-50 rounded-lg">
                                <div class="flex-1 min-w-0 pr-2">
                                    <p class="font-medium truncate">${p.name}</p>
                                    <p class="text-xs text-gray-500">Harga: ${formatCurrency(p.price)} | Barcode: ${p.barcode}</p>
                                </div>
                                <button onclick="deleteProduct('${p.id}')" class="text-red-500 hover:text-red-700">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- Database Management -->
                <div class="bg-white p-4 rounded-xl card-shadow">
                    <h3 class="font-semibold text-lg mb-3 text-gray-700 flex items-center">
                        <i data-lucide="database" class="w-5 h-5 mr-2 text-red-600"></i>
                        Database (Backup/Restore)
                    </h3>
                    <button onclick="downloadDatabase()" class="w-full bg-red-500 text-white py-2 rounded-lg font-bold hover:bg-red-600 transition mb-3">
                        <i data-lucide="cloud-download" class="inline w-5 h-5 mr-2"></i>
                        Unduh Data (JSON)
                    </button>
                    <input type="file" id="database-upload" accept=".json" class="file-input" onchange="uploadDatabase(event)">
                    <button onclick="document.getElementById('database-upload').click()" class="w-full bg-yellow-500 text-white py-2 rounded-lg font-bold hover:bg-yellow-600 transition">
                        <i data-lucide="cloud-upload" class="inline w-5 h-5 mr-2"></i>
                        Unggah Data (JSON)
                    </button>
                    <p class="text-xs text-gray-500 mt-2 text-center">Data yang diunduh/diunggah mencakup Produk & Transaksi.</p>
                </div>
            `;
            lucide.createIcons();
        };


        // ====================================================================
        // 6. LOGIC FUNCTIONS
        // ====================================================================
        
        // 6.1. Navigation
        const switchView = (viewId) => {
            document.querySelectorAll('.view').forEach(view => view.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.tab-button[data-view="${viewId}"]`).classList.add('active');
            state.currentView = viewId;
            // Re-render only the necessary view
            if (viewId === 'kasir-view') renderKasirView();
            if (viewId === 'laporan-view') renderLaporanView();
            if (viewId === 'keuangan-view') renderKeuanganView();
            if (viewId === 'pengaturan-view') renderSettingsView();
        };

        // Event Listeners for Navigation
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => switchView(button.getAttribute('data-view')));
        });

        // 6.2. Kasir/Cart Logic
        
        window.handleBarcodeScan = (barcode) => {
            const product = state.products.find(p => p.barcode === barcode);
            if (product) {
                addToCart(product.id);
                showMessage('Berhasil', `${product.name} telah ditambahkan ke keranjang.`);
            } else {
                showMessage('Gagal', `Barcode ${barcode} tidak ditemukan di database.`, true);
            }
        };

        window.addToCart = (productId) => {
            const product = state.products.find(p => p.id === productId);
            if (!product) return;

            const existingItem = state.cart.find(item => item.id === productId);
            if (existingItem) {
                existingItem.qty += 1;
            } else {
                state.cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    qty: 1
                });
            }
            renderKasirView();
        };

        window.updateCartQty = (productId, change) => {
            const itemIndex = state.cart.findIndex(item => item.id === productId);
            if (itemIndex > -1) {
                state.cart[itemIndex].qty += change;
                if (state.cart[itemIndex].qty <= 0) {
                    state.cart.splice(itemIndex, 1);
                }
            }
            renderKasirView();
        };

        window.handleCheckout = (total) => {
            if (state.cart.length === 0) return;

            const cart = [...state.cart]; // Copy cart items
            const cartHtml = cart.map(item => `
                <div class="flex justify-between text-sm">
                    <span class="flex-1">${item.name}</span>
                    <span class="w-12 text-center">${item.qty}</span>
                    <span class="w-20 text-right">${formatCurrency(item.price * item.qty)}</span>
                </div>
            `).join('');

            const receiptModal = `
                <div class="bg-white p-6 rounded-lg w-full max-w-sm card-shadow transform transition-all duration-300">
                    <h3 class="text-xl font-bold mb-4 text-blue-600">Konfirmasi Pembayaran</h3>
                    <div class="flex justify-between text-2xl font-extrabold mb-4 border-t pt-2">
                        <span>Total Bayar:</span>
                        <span class="text-green-600">${formatCurrency(total)}</span>
                    </div>
                    
                    <input type="number" id="payment-input" placeholder="Jumlah Tunai Pelanggan" class="input-style mb-4" autofocus>
                    <p id="change-display" class="text-lg font-bold text-center text-red-600 mb-4">Kembalian: -</p>

                    <div class="flex space-x-2">
                        <button id="close-checkout" class="flex-1 bg-gray-400 text-white py-2 rounded-lg hover:bg-gray-500 transition">Batal</button>
                        <button id="process-payment" disabled class="flex-1 bg-green-500 text-white py-2 rounded-lg font-bold hover:bg-green-600 transition disabled:opacity-50">Proses</button>
                    </div>

                    <h4 class="font-semibold mt-4 border-t pt-3 text-gray-700">Preview Struk</h4>
                    <div id="receipt-preview-area" class="border p-2 mt-2 max-h-40 overflow-y-auto">
                        <!-- Receipt Content goes here -->
                    </div>
                </div>
            `;
            
            showModal(receiptModal);

            const paymentInput = document.getElementById('payment-input');
            const processButton = document.getElementById('process-payment');
            const changeDisplay = document.getElementById('change-display');
            const receiptPreviewArea = document.getElementById('receipt-preview-area');

            // Generate initial receipt preview
            receiptPreviewArea.innerHTML = generateReceiptHTML(cart, total, 0);

            // Calculate change and enable button on input
            paymentInput.addEventListener('input', () => {
                const paid = parseInt(paymentInput.value) || 0;
                const change = paid - total;
                
                changeDisplay.textContent = `Kembalian: ${formatCurrency(change)}`;
                changeDisplay.classList.toggle('text-red-600', change < 0);
                changeDisplay.classList.toggle('text-green-600', change >= 0);
                
                processButton.disabled = change < 0;
            });
            
            // Process Payment
            processButton.onclick = async () => {
                const paid = parseInt(paymentInput.value);
                const change = paid - total;

                // 1. Save Transaction
                const transaction = {
                    total: total,
                    paid: paid,
                    change: change,
                    items: cart.map(item => ({ name: item.name, price: item.price, qty: item.qty })),
                    cashier: state.settings.cashierName,
                    store: state.settings.storeName,
                    timestamp: serverTimestamp()
                };

                try {
                    if (db) {
                        const transactionsRef = getPublicCollectionRef('transactions');
                        await addDoc(transactionsRef, transaction);
                    }
                    // 2. Clear Cart and Show Success/Receipt
                    state.cart = [];
                    renderKasirView();
                    hideModal();
                    
                    // Show final receipt (Simulasi Cetak/Simpan)
                    showFinalReceiptModal(cart, total, change, paid, transaction.id || 'LOCAL-12345');

                } catch (error) {
                    showMessage('Error Transaksi', `Gagal menyimpan transaksi: ${error.message}`, true);
                }
            };
            
            document.getElementById('close-checkout').onclick = hideModal;
        };

        const generateReceiptHTML = (cart, total, change, paid = 0, txId = 'LOCAL-12345') => {
             const time = new Date().toLocaleString('id-ID', { dateStyle: 'short', timeStyle: 'short' });
             const { storeName, address, cashierName, logoUrl } = state.settings;

            return `
                <div id="receipt-content">
                    <div class="text-center mb-2">
                        <img src="${logoUrl}" onerror="this.style.display='none'" class="h-10 mx-auto mb-1">
                        <p class="font-extrabold text-lg">${storeName}</p>
                        <p class="text-xs whitespace-pre-wrap">${address}</p>
                    </div>
                    <div class="border-t border-dashed border-gray-600 pt-1 mb-1"></div>
                    <p>Waktu: ${time}</p>
                    <p>Kasir: ${cashierName}</p>
                    <p>ID Transaksi: ${txId}</p>
                    <div class="border-t border-dashed border-gray-600 my-1"></div>
                    
                    <div class="flex font-bold">
                        <span class="flex-1">ITEM</span>
                        <span class="w-12 text-center">QTY</span>
                        <span class="w-20 text-right">TOTAL</span>
                    </div>
                    <div class="border-b border-dashed border-gray-600 my-1"></div>
                    
                    ${cart.map(item => `
                        <div class="flex">
                            <span class="flex-1">${item.name} @${formatCurrency(item.price)}</span>
                            <span class="w-12 text-center">${item.qty}</span>
                            <span class="w-20 text-right">${formatCurrency(item.price * item.qty)}</span>
                        </div>
                    `).join('')}

                    <div class="border-t border-dashed border-gray-600 my-1"></div>
                    
                    <div class="flex justify-between font-bold text-base">
                        <span>TOTAL</span>
                        <span>${formatCurrency(total)}</span>
                    </div>

                    ${paid > 0 ? `
                    <div class="flex justify-between text-sm">
                        <span>TUNAI</span>
                        <span>${formatCurrency(paid)}</span>
                    </div>
                    <div class="flex justify-between font-bold text-base mt-1">
                        <span>KEMBALIAN</span>
                        <span>${formatCurrency(change)}</span>
                    </div>
                    ` : ''}

                    <div class="border-t border-dashed border-gray-600 my-2"></div>
                    <p class="text-center text-xs">TERIMA KASIH TELAH BERBELANJA!</p>
                </div>
            `;
        };
        
        const showFinalReceiptModal = (cart, total, change, paid, txId) => {
            const receiptHTML = generateReceiptHTML(cart, total, change, paid, txId);
            
            const modalContent = `
                <div class="bg-white p-4 rounded-lg w-full max-w-sm card-shadow transform transition-all duration-300">
                    <h3 class="text-xl font-bold mb-3 text-green-600 text-center">Transaksi Berhasil!</h3>
                    
                    <div id="receipt-export-area" class="flex justify-center mb-4 border border-gray-300 bg-gray-50 p-2 rounded-lg overflow-x-auto mx-auto">
                        ${receiptHTML}
                    </div>

                    <div class="space-y-3">
                        <button onclick="exportReceiptToPNG('${txId}')" class="w-full bg-indigo-500 text-white py-2 rounded-lg font-bold hover:bg-indigo-600 transition">
                            <i data-lucide="image" class="inline w-5 h-5 mr-2"></i>
                            Simpan Struk (PNG)
                        </button>
                        <button onclick="shareReceipt('${txId}', ${total})" class="w-full bg-teal-500 text-white py-2 rounded-lg font-bold hover:bg-teal-600 transition">
                            <i data-lucide="share-2" class="inline w-5 h-5 mr-2"></i>
                            Bagikan Struk
                        </button>
                        <button onclick="hideModal()" class="w-full bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition">
                            <i data-lucide="check" class="inline w-5 h-5 mr-2"></i>
                            Selesai
                        </button>
                    </div>
                </div>
            `;
            showModal(modalContent);
            lucide.createIcons();
        };

        window.exportReceiptToPNG = (txId) => {
            const element = document.getElementById('receipt-export-area').querySelector('#receipt-content');
            
            html2canvas(element, { 
                scale: 3, 
                useCORS: true, 
                backgroundColor: 'white' // Ensure white background
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `struk_arkasir_${txId}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                showMessage('Berhasil', 'Struk berhasil diunduh sebagai PNG.');
            }).catch(e => {
                console.error("Error exporting receipt:", e);
                showMessage('Gagal', 'Gagal mengunduh struk. Coba lagi.', true);
            });
        };

        window.shareReceipt = (txId, total) => {
            const text = `ðŸŽ‰ Transaksi ArKasir Berhasil!\n\nID Transaksi: ${txId}\nTotal: ${formatCurrency(total)}\nKasir: ${state.settings.cashierName}\nToko: ${state.settings.storeName}\n\nTerima kasih telah berbelanja!`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Struk ArKasir',
                    text: text,
                }).catch(error => {
                    console.error('Sharing failed', error);
                });
            } else {
                navigator.clipboard.writeText(text).then(() => {
                    showMessage('Berhasil', 'Informasi struk (teks) berhasil disalin ke clipboard. Anda bisa membagikannya secara manual.');
                }).catch(err => {
                    showMessage('Gagal', 'Gagal menyalin teks struk.', true);
                    console.error('Could not copy text: ', err);
                });
            }
        };

        // 6.3. Report Logic
        
        const calculateReports = () => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const oneWeekAgo = new Date(today.getTime() - (7 * 24 * 60 * 60 * 1000));
            const oneMonthAgo = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());

            let dailyTotal = 0;
            let dailyCount = 0;
            let weeklyTotal = 0;
            let weeklyCount = 0;
            let monthlyTotal = 0;
            let monthlyCount = 0;

            state.transactions.forEach(tx => {
                const txDate = tx.timestamp.toDate ? tx.timestamp.toDate() : new Date(tx.timestamp);

                if (txDate >= today) {
                    dailyTotal += tx.total;
                    dailyCount++;
                }
                if (txDate >= oneWeekAgo) {
                    weeklyTotal += tx.total;
                    weeklyCount++;
                }
                if (txDate >= oneMonthAgo) {
                    monthlyTotal += tx.total;
                    monthlyCount++;
                }
            });

            state.reportData = {
                daily: { date: new Date().toISOString().split('T')[0], total: dailyTotal, count: dailyCount },
                weekly: { total: weeklyTotal, count: weeklyCount },
                monthly: { total: monthlyTotal, count: monthlyCount },
            };
        };

        const generateLast7DaysData = (transactions) => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const daysData = {};

            // Initialize 7 days
            for (let i = 0; i < 7; i++) {
                const date = new Date(today.getTime() - (i * 24 * 60 * 60 * 1000));
                const key = date.toISOString().split('T')[0];
                daysData[key] = { date: date.toLocaleDateString('id-ID', { weekday: 'short', day: 'numeric' }), total: 0 };
            }

            // Aggregate transaction data
            transactions.forEach(tx => {
                const txDate = tx.timestamp.toDate ? tx.timestamp.toDate() : new Date(tx.timestamp);
                const key = txDate.toISOString().split('T')[0];
                if (daysData[key]) {
                    daysData[key].total += tx.total;
                }
            });

            // Format for Chart.js (reverse to get chronological order)
            const labels = Object.values(daysData).map(d => d.date).reverse();
            const data = Object.values(daysData).map(d => d.total).reverse();
            return { labels, data };
        };

        const renderChart = (data) => {
            if (reportChartInstance) {
                reportChartInstance.destroy();
            }

            const ctx = document.getElementById('salesChart').getContext('2d');
            reportChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Pendapatan (IDR)',
                        data: data.data,
                        backgroundColor: 'rgba(59, 130, 246, 0.7)', // blue-500
                        borderColor: 'rgb(37, 99, 235)',
                        borderWidth: 1,
                        borderRadius: 4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatCurrency(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        };

        window.exportReportToPNG = () => {
            const element = document.getElementById('report-chart-area');
            
            html2canvas(element, { 
                scale: 3, 
                useCORS: true, 
                backgroundColor: 'white' 
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `laporan_arkasir_${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                showMessage('Berhasil', 'Laporan berhasil diunduh sebagai PNG.');
            }).catch(e => {
                console.error("Error exporting report:", e);
                showMessage('Gagal', 'Gagal mengunduh laporan. Coba lagi.', true);
            });
        };

        // 6.4. Keuangan (Non-Kasir) Logic
        
        window.addFinanceLog = async () => {
            const type = document.getElementById('finance-type').value;
            const amount = parseInt(document.getElementById('finance-amount').value);
            const description = document.getElementById('finance-desc').value;

            if (!amount || amount <= 0 || !description) {
                showMessage('Input Error', 'Semua kolom harus diisi dengan benar.', true);
                return;
            }

            const newLog = {
                type: type, // 'in' or 'out'
                amount: amount,
                description: description,
                timestamp: serverTimestamp(),
                cashier: state.settings.cashierName
            };

            try {
                if (db) {
                    const financeRef = getPrivateCollectionRef('finance_log');
                    await addDoc(financeRef, newLog);
                }
                document.getElementById('finance-amount').value = '';
                document.getElementById('finance-desc').value = '';
                showMessage('Berhasil', 'Catatan keuangan berhasil ditambahkan.');
            } catch (error) {
                showMessage('Gagal', `Gagal menyimpan catatan: ${error.message}`, true);
            }
        };

        // 6.5. Settings/Product Management Logic
        
        window.saveSettings = async () => {
            const storeName = document.getElementById('setting-storeName').value;
            const cashierName = document.getElementById('setting-cashierName').value;
            const address = document.getElementById('setting-address').value;
            
            const newSettings = { storeName, cashierName, address, logoUrl: state.settings.logoUrl };
            
            try {
                if (db) {
                    const settingsRef = getPrivateDocRef('settings', 'store_config');
                    await setDoc(settingsRef, newSettings, { merge: true });
                }
                showMessage('Berhasil', 'Pengaturan toko berhasil disimpan.');
            } catch (error) {
                showMessage('Gagal', `Gagal menyimpan pengaturan: ${error.message}`, true);
            }
        };

        window.previewLogo = (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const logoUrl = e.target.result;
                    
                    // Update state and save to Firestore
                    state.settings.logoUrl = logoUrl;
                    document.querySelector('#pengaturan-view img').src = logoUrl;
                    
                    try {
                        if (db) {
                            const settingsRef = getPrivateDocRef('settings', 'store_config');
                            await setDoc(settingsRef, { logoUrl: logoUrl }, { merge: true });
                        }
                        showMessage('Berhasil', 'Logo toko berhasil diunggah dan disimpan.');
                    } catch (error) {
                        showMessage('Gagal', `Gagal menyimpan logo: ${error.message}`, true);
                    }
                };
                reader.readAsDataURL(file);
            }
        };

        window.addProduct = async () => {
            const name = document.getElementById('new-product-name').value;
            const barcode = document.getElementById('new-product-barcode').value;
            const price = parseInt(document.getElementById('new-product-price').value);

            if (!name || !barcode || !price || price <= 0) {
                showMessage('Input Error', 'Nama, Barcode, dan Harga harus diisi dengan benar.', true);
                return;
            }

            const newProduct = { name, barcode, price };

            try {
                if (db) {
                    const productsRef = getPublicCollectionRef('products');
                    await addDoc(productsRef, newProduct);
                }
                document.getElementById('new-product-name').value = '';
                document.getElementById('new-product-barcode').value = '';
                document.getElementById('new-product-price').value = '';
                showMessage('Berhasil', `${name} berhasil ditambahkan.`);
            } catch (error) {
                showMessage('Gagal', `Gagal menambah produk: ${error.message}`, true);
            }
        };

        window.deleteProduct = async (productId) => {
            if (!confirm('Apakah Anda yakin ingin menghapus produk ini?')) return;
            try {
                if (db) {
                    const productDocRef = doc(getPublicCollectionRef('products'), productId);
                    await deleteDoc(productDocRef);
                }
                showMessage('Berhasil', 'Produk berhasil dihapus.');
            } catch (error) {
                showMessage('Gagal', `Gagal menghapus produk: ${error.message}`, true);
            }
        };

        // 6.6. Database Backup/Restore Logic

        window.downloadDatabase = () => {
            const dataToExport = {
                products: state.products,
                transactions: state.transactions.map(tx => ({
                    ...tx,
                    // Convert Firestore Timestamps to ISO strings for export
                    timestamp: tx.timestamp.toDate ? tx.timestamp.toDate().toISOString() : tx.timestamp
                })),
                financeLog: state.financeLog.map(f => ({
                    ...f,
                    timestamp: f.timestamp.toDate ? f.timestamp.toDate().toISOString() : f.timestamp
                }))
            };

            const jsonString = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([jsonString], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `arkasir_backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            showMessage('Berhasil', 'Data berhasil diunduh sebagai file JSON.');
        };

        window.uploadDatabase = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const jsonContent = JSON.parse(e.target.result);
                    
                    if (!db) {
                        showMessage('Gagal', 'Firebase tidak terinisialisasi. Tidak dapat mengunggah data.', true);
                        return;
                    }
                    
                    if (!confirm('PERINGATAN: Mengunggah data akan MENGHAPUS data Produk, Transaksi, dan Keuangan NON-KASIR yang ada. Lanjutkan?')) return;
                    
                    const batch = writeBatch(db);
                    
                    // --- 1. Products ---
                    const productsRef = getPublicCollectionRef('products');
                    // Delete existing products
                    const existingProducts = await getDocs(productsRef);
                    existingProducts.forEach(doc => batch.delete(doc.ref));
                    // Add new products
                    jsonContent.products.forEach(p => {
                        const newDocRef = doc(productsRef);
                        batch.set(newDocRef, p);
                    });

                    // --- 2. Transactions ---
                    const transactionsRef = getPublicCollectionRef('transactions');
                    // Delete existing transactions
                    const existingTransactions = await getDocs(transactionsRef);
                    existingTransactions.forEach(doc => batch.delete(doc.ref));
                    // Add new transactions
                    jsonContent.transactions.forEach(tx => {
                        const newDocRef = doc(transactionsRef);
                        // Convert ISO string back to Date object (Firestore will handle conversion to Timestamp)
                        batch.set(newDocRef, { ...tx, timestamp: new Date(tx.timestamp) });
                    });
                    
                    // --- 3. Finance Log ---
                    const financeRef = getPrivateCollectionRef('finance_log');
                    // Delete existing finance logs
                    const existingFinance = await getDocs(financeRef);
                    existingFinance.forEach(doc => batch.delete(doc.ref));
                    // Add new logs
                    jsonContent.financeLog.forEach(f => {
                        const newDocRef = doc(financeRef);
                        batch.set(newDocRef, { ...f, timestamp: new Date(f.timestamp) });
                    });

                    await batch.commit();
                    showMessage('Berhasil', 'Database berhasil diunggah dan diperbarui.');
                } catch (error) {
                    console.error("Upload Error:", error);
                    showMessage('Gagal', `Gagal mengunggah data. Pastikan file JSON valid: ${error.message}`, true);
                }
            };
            reader.readAsText(file);
        };


        // ====================================================================
        // 7. MODAL AND PWA UTILITIES
        // ====================================================================

        const modalContainer = document.getElementById('modal-container');
        
        const showModal = (contentHTML) => {
            modalContainer.innerHTML = contentHTML;
            modalContainer.classList.remove('hidden');
        };

        const hideModal = () => {
            modalContainer.classList.add('hidden');
        };
        
        // PWA Setup
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const installButton = document.getElementById('pwa-install-button');
            installButton.classList.remove('hidden');
            
            installButton.addEventListener('click', () => {
                installButton.classList.add('hidden');
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    } else {
                        console.log('User dismissed the install prompt');
                    }
                    deferredPrompt = null;
                });
            });
        });

        // Simple Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('SW registered: ', registration);
                }).catch(registrationError => {
                    console.log('SW registration failed: ', registrationError);
                });
            });
        }
    </script>

    <!-- PWA Service Worker (Embedded in HTML for single file mandate) -->
    <script id="sw-script" type="application/javascript">
        /*
         * This script generates a dynamic Service Worker (sw.js) blob URL 
         * and registers it, fulfilling the PWA requirement in a single HTML file.
         */
        const swContent = `
            const CACHE_NAME = 'arkasir-cache-v1';
            const urlsToCache = [
                '/', 
                '/index.html',
                'https://cdn.tailwindcss.com',
                'https://unpkg.com/lucide@latest',
                'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js',
                'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js'
            ];

            self.addEventListener('install', event => {
                event.waitUntil(
                    caches.open(CACHE_NAME)
                        .then(cache => {
                            console.log('Opened cache');
                            return cache.addAll(urlsToCache).catch(error => {
                                console.error('Failed to cache resources:', error);
                            });
                        })
                );
            });

            self.addEventListener('fetch', event => {
                event.respondWith(
                    caches.match(event.request)
                        .then(response => {
                            if (response) {
                                return response;
                            }
                            return fetch(event.request);
                        })
                );
            });
        `;
        
        const blob = new Blob([swContent], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(blob);
        
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register(swUrl, { scope: '/' })
                .then(registration => {
                    console.log('SW (Blob) registered successfully: ', registration);
                })
                .catch(error => {
                    console.error('SW (Blob) registration failed: ', error);
                });
        }
    </script>

    <!-- PWA Manifest (Embedded in HTML) -->
    <script id="manifest-script" type="application/json">
        {
          "name": "ArKasir POS",
          "short_name": "ArKasir",
          "description": "Aplikasi Kasir POS Mobile Sederhana",
          "start_url": "./",
          "display": "standalone",
          "background_color": "#ffffff",
          "theme_color": "#3b82f6",
          "icons": [
            {
              "src": "https://placehold.co/192x192/3b82f6/ffffff?text=AK",
              "sizes": "192x192",
              "type": "image/png"
            },
            {
              "src": "https://placehold.co/512x512/3b82f6/ffffff?text=AK",
              "sizes": "512x512",
              "type": "image/png"
            }
          ]
        }
    </script>
    <script>
        // Manually inject manifest link tag
        const manifest = document.createElement('link');
        manifest.rel = 'manifest';
        manifest.href = 'data:application/json;base64,' + btoa(document.getElementById('manifest-script').textContent);
        document.head.appendChild(manifest);
    </script>
</body>
</html>

