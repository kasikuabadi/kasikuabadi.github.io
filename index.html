<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>arkasir - Kasir Mobile POS</title>
    <!-- Tailwind CSS CDN untuk styling mobile-first dan responsif -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HTML2Canvas untuk men-download struk dan laporan sebagai PNG -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Menggunakan Font Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }

        /* Kustomisasi scrollbar untuk tampilan yang lebih baik */
        .overflow-y-scroll::-webkit-scrollbar { width: 4px; }
        .overflow-y-scroll::-webkit-scrollbar-thumb { background: #34d399; border-radius: 2px; }
        .overflow-y-scroll::-webkit-scrollbar-track { background: #1f2937; }

        /* Style untuk modal print/preview */
        .receipt-preview {
            width: 300px; /* Lebar standar kertas struk */
            padding: 10px;
            font-size: 10px;
            line-height: 1.3;
            background-color: white;
            color: #1f2937;
        }
        @media print {
            body > *:not(.print-area) { display: none !important; }
            .print-area {
                display: block;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                margin: 0;
                padding: 0;
                box-shadow: none;
            }
            .receipt-preview {
                width: 100%;
                font-size: 12px;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <!-- Kontainer utama aplikasi -->
    <div id="app" class="flex flex-col flex-grow max-w-md mx-auto w-full shadow-lg bg-white rounded-t-xl overflow-hidden">

        <!-- Header Aplikasi -->
        <header class="p-4 bg-emerald-600 text-white shadow-md flex justify-between items-center">
            <h1 class="text-xl font-bold">arkasir</h1>
            <button onclick="navigate('Settings')" class="text-white hover:text-emerald-200 p-2 rounded-full transition duration-150">
                <span class="text-2xl">‚öôÔ∏è</span>
            </button>
        </header>

        <!-- Area Konten (Akan diganti berdasarkan navigasi) -->
        <main id="content-area" class="flex-grow p-4 overflow-y-auto pb-20"></main>

        <!-- Navigasi Bawah (Bottom Bar) -->
        <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white shadow-2xl border-t border-gray-200 z-50">
            <div class="flex justify-around items-center h-16">
                <button onclick="navigate('POS')" class="nav-btn flex flex-col items-center justify-center p-2 text-sm text-gray-500 hover:text-emerald-600 transition duration-150">
                    <span class="text-2xl">üõí</span>
                    <span class="mt-0.5">Kasir</span>
                </button>
                <button onclick="navigate('PettyCash')" class="nav-btn flex flex-col items-center justify-center p-2 text-sm text-gray-500 hover:text-emerald-600 transition duration-150">
                    <span class="text-2xl">üí∞</span>
                    <span class="mt-0.5">Masuk/Keluar</span>
                </button>
                <button onclick="navigate('Reports')" class="nav-btn flex flex-col items-center justify-center p-2 text-sm text-gray-500 hover:text-emerald-600 transition duration-150">
                    <span class="text-2xl">üìä</span>
                    <span class="mt-0.5">Laporan</span>
                </button>
                <button onclick="navigate('Products')" class="nav-btn flex flex-col items-center justify-center p-2 text-sm text-gray-500 hover:text-emerald-600 transition duration-150">
                    <span class="text-2xl">üì¶</span>
                    <span class="mt-0.5">Produk</span>
                </button>
            </div>
        </nav>

    </div>

    <!-- Modal (Digunakan untuk Preview Struk dan Pesan) -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div id="modal-content" class="bg-white rounded-xl shadow-2xl m-4 max-w-xs w-full p-6">
            <!-- Konten Modal akan dimuat di sini -->
        </div>
    </div>

    <!-- Area Tersembunyi untuk Print dan Export PNG -->
    <div id="print-export-area" class="fixed top-0 left-0 opacity-0 -z-50 print-area"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, onSnapshot, collection, query, orderBy, deleteDoc, getDocs, runTransaction, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Log level untuk debug Firestore
        setLogLevel('Debug');

        // Global State & Firebase Initialization
        window.appState = {
            userId: null,
            db: null,
            auth: null,
            appId: 'default-app-id',
            isAuthReady: false,
            settings: { storeName: 'Toko ArKasir', cashierName: 'Kasir Utama', address: 'Alamat Toko Anda', logoUrl: '' },
            products: [],
            cart: [],
            transactions: [],
            pettyCash: [],
            currentPage: 'POS',
        };

        // Mengambil konfigurasi Firebase dari lingkungan Canvas
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        window.appState.appId = appId;

        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        window.appState.db = db;
        window.appState.auth = auth;

        /**
         * Mengautentikasi pengguna dan menyiapkan userId.
         */
        async function authenticateUser() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Auth Error:", error);
            }
        }

        /**
         * Mendapatkan path koleksi atau dokumen.
         * @param {string} type - 'products', 'transactions', 'settings', 'petty_cash'.
         * @param {string} docId - ID dokumen opsional.
         * @returns {string} Path Firestore.
         */
        window.getFirestorePath = (type, docId = null) => {
            const userId = window.appState.userId;
            const appId = window.appState.appId;
            const base = `artifacts/${appId}/users/${userId}`;

            switch (type) {
                case 'settings':
                    return docId ? `${base}/settings/${docId}` : `${base}/settings`;
                case 'products':
                    return docId ? `${base}/products/${docId}` : `${base}/products`;
                case 'transactions':
                    return docId ? `${base}/transactions/${docId}` : `${base}/transactions`;
                case 'petty_cash':
                    return docId ? `${base}/petty_cash/${docId}` : `${base}/petty_cash`;
                default:
                    throw new Error("Invalid Firestore path type.");
            }
        };

        /**
         * Setup listener real-time untuk Settings, Products, Transactions, dan Petty Cash.
         */
        function setupListeners(userId) {
            const db = window.appState.db;

            // 1. Settings Listener (Dokumen)
            const settingsDocRef = doc(db, window.getFirestorePath('settings', 'storeInfo'));
            onSnapshot(settingsDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    window.appState.settings = { ...window.appState.settings, ...docSnap.data() };
                } else {
                    // Jika belum ada, buat dokumen default
                    setDoc(settingsDocRef, window.appState.settings, { merge: true }).catch(console.error);
                }
                renderApp(); // Render ulang setelah settings dimuat
            }, (error) => console.error("Error fetching settings:", error));

            // 2. Products Listener (Koleksi)
            const productsColRef = collection(db, window.getFirestorePath('products'));
            onSnapshot(query(productsColRef, orderBy('name', 'asc')), (snapshot) => {
                window.appState.products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (window.appState.currentPage === 'Products') renderApp();
            }, (error) => console.error("Error fetching products:", error));

            // 3. Transactions Listener (Koleksi)
            const transactionsColRef = collection(db, window.getFirestorePath('transactions'));
            onSnapshot(query(transactionsColRef, orderBy('timestamp', 'desc')), (snapshot) => {
                window.appState.transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (window.appState.currentPage === 'Reports') renderApp();
            }, (error) => console.error("Error fetching transactions:", error));

            // 4. Petty Cash Listener (Koleksi)
            const pettyCashColRef = collection(db, window.getFirestorePath('petty_cash'));
            onSnapshot(query(pettyCashColRef, orderBy('timestamp', 'desc')), (snapshot) => {
                window.appState.pettyCash = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (window.appState.currentPage === 'PettyCash' || window.appState.currentPage === 'Reports') renderApp();
            }, (error) => console.error("Error fetching petty cash:", error));
        }

        // --- Auth State Change Listener ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.appState.userId = user.uid;
                window.appState.isAuthReady = true;
                console.log("Authenticated User ID:", user.uid);
                setupListeners(user.uid);
                window.navigate(window.appState.currentPage); // Arahkan ke halaman POS setelah autentikasi
            } else {
                console.log("No user signed in. Attempting sign-in...");
                // Jika belum ada user, mulai proses autentikasi
                if (!window.appState.isAuthReady) {
                    authenticateUser();
                }
            }
        });

        // --- Global Helper Functions ---

        /**
         * Navigasi antar halaman
         * @param {string} page - Nama halaman: 'POS', 'Reports', 'Settings', 'PettyCash', 'Products'.
         */
        window.navigate = (page) => {
            window.appState.currentPage = page;
            renderApp();
        };

        /**
         * Format angka menjadi mata uang Rupiah
         * @param {number} number - Angka yang akan diformat.
         * @returns {string} String Rupiah.
         */
        window.formatRupiah = (number) => {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(number);
        };

        /**
         * Menampilkan modal dengan konten tertentu.
         * @param {string} title - Judul modal.
         * @param {string} contentHtml - Konten HTML di dalam modal.
         * @param {boolean} showClose - Tampilkan tombol tutup.
         */
        window.showModal = (title, contentHtml, showClose = true) => {
            const modalBackdrop = document.getElementById('modal-backdrop');
            const modalContent = document.getElementById('modal-content');

            modalContent.innerHTML = `
                <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-200">
                    <h3 class="text-lg font-bold text-emerald-600">${title}</h3>
                    ${showClose ? `<button onclick="window.closeModal()" class="text-gray-400 hover:text-gray-600">
                        <span class="text-xl">‚úï</span>
                    </button>` : ''}
                </div>
                ${contentHtml}
            `;
            modalBackdrop.classList.remove('hidden');
            modalBackdrop.classList.add('flex');
        };

        /** Menutup modal. */
        window.closeModal = () => {
            const modalBackdrop = document.getElementById('modal-backdrop');
            modalBackdrop.classList.add('hidden');
            modalBackdrop.classList.remove('flex');
        };


        // --- Implementasi Fungsi UI ---

        /** Render Tampilan Halaman POS */
        window.renderPOS = () => {
            const { products, cart } = window.appState;

            const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
            const totalRupiah = window.formatRupiah(total);

            const cartHtml = cart.length === 0
                ? '<p class="text-center text-gray-500 pt-10">Keranjang kosong. Tambahkan produk!</p>'
                : cart.map((item, index) => `
                    <div class="flex justify-between items-center p-2 border-b last:border-b-0">
                        <div class="flex-grow">
                            <p class="font-semibold text-gray-800">${item.name}</p>
                            <p class="text-xs text-gray-500">${window.formatRupiah(item.price)} x ${item.quantity}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="font-bold text-emerald-600">${window.formatRupiah(item.price * item.quantity)}</span>
                            <button onclick="window.updateCartQuantity('${item.id}', -1)" class="text-red-500 p-1 rounded-full text-lg">‚ûñ</button>
                            <button onclick="window.updateCartQuantity('${item.id}', 1)" class="text-green-500 p-1 rounded-full text-lg">‚ûï</button>
                            <button onclick="window.removeFromCart('${item.id}')" class="text-red-700 p-1 rounded-full text-lg">üóëÔ∏è</button>
                        </div>
                    </div>
                `).join('');

            const productListHtml = products.map(product => `
                <button onclick="window.addToCart('${product.id}')" class="bg-white p-3 rounded-lg shadow-sm hover:shadow-md transition duration-150 border border-gray-200 text-left">
                    <p class="font-bold text-gray-800">${product.name}</p>
                    <p class="text-sm text-emerald-600">${window.formatRupiah(product.price)}</p>
                </button>
            `).join('');

            return `
                <div class="flex flex-col h-full space-y-4">
                    <h2 class="text-2xl font-extrabold text-gray-800 mb-2">Kasir Cepat</h2>

                    <!-- Barcode/Pencarian Produk -->
                    <div class="sticky top-0 bg-white pt-1 pb-4 z-10 border-b border-gray-200">
                        <div class="flex items-center space-x-2">
                            <span class="text-2xl">üîç</span>
                            <input type="text" id="barcode-input" onkeyup="window.handleBarcodeScan(event)" placeholder="Scan Barcode / Cari Produk" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" autofocus>
                        </div>
                        <small class="text-xs text-gray-500 mt-1 block">Tekan Enter untuk mensimulasikan scan barcode.</small>
                    </div>

                    <!-- Daftar Produk Cepat -->
                    <div class="grid grid-cols-2 gap-3 mb-4 max-h-40 overflow-y-scroll p-2 bg-gray-50 rounded-lg">
                        ${productListHtml.length > 0 ? productListHtml : '<p class="col-span-2 text-center text-gray-500">Tambahkan produk di menu Produk.</p>'}
                    </div>

                    <!-- Keranjang Belanja -->
                    <div class="flex-grow bg-white border border-gray-200 rounded-lg shadow-inner overflow-y-scroll max-h-80">
                        ${cartHtml}
                    </div>

                    <!-- Total dan Pembayaran -->
                    <div class="sticky bottom-0 bg-white p-4 -mx-4 border-t border-gray-200 shadow-xl">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-xl font-semibold text-gray-600">TOTAL</span>
                            <span class="text-3xl font-extrabold text-emerald-700">${totalRupiah}</span>
                        </div>
                        <button onclick="window.processPayment()" ${cart.length === 0 ? 'disabled' : ''} class="w-full py-4 bg-emerald-600 text-white font-bold text-lg rounded-xl shadow-lg hover:bg-emerald-700 transition duration-150 disabled:bg-gray-400">
                            Bayar Sekarang
                        </button>
                    </div>
                </div>
            `;
        };

        /** Render Tampilan Halaman Laporan */
        window.renderReports = () => {
            const { transactions, pettyCash } = window.appState;
            const now = new Date();
            const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

            const dailyReport = window.generateReport(transactions, pettyCash, 'daily');
            const weeklyReport = window.generateReport(transactions, pettyCash, 'weekly', startOfWeek);
            const monthlyReport = window.generateReport(transactions, pettyCash, 'monthly', startOfMonth);

            const reportCards = (title, report) => `
                <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-200 mb-4">
                    <h3 class="text-xl font-bold text-gray-800 mb-3">${title}</h3>
                    <div class="space-y-2 text-sm">
                        <p class="flex justify-between font-semibold"><span>Penjualan (Transaksi)</span><span class="text-emerald-600">${window.formatRupiah(report.sales)}</span></p>
                        <p class="flex justify-between font-semibold"><span>Pemasukan Lain</span><span class="text-emerald-600">${window.formatRupiah(report.income)}</span></p>
                        <p class="flex justify-between font-semibold"><span>Pengeluaran</span><span class="text-red-600">(${window.formatRupiah(report.expense)})</span></p>
                        <div class="pt-2 border-t border-gray-200">
                            <p class="flex justify-between text-lg font-extrabold"><span>Laba Bersih</span><span class="${report.profit >= 0 ? 'text-blue-600' : 'text-red-600'}">${window.formatRupiah(report.profit)}</span></p>
                        </div>
                    </div>
                    ${report.transactionsCount > 0 ? `<p class="text-xs text-gray-500 mt-2">${report.transactionsCount} Transaksi penjualan.</p>` : ''}

                    <!-- Analisa Sederhana -->
                    <div class="mt-4 p-3 bg-blue-50 rounded-lg text-sm">
                        <p class="font-bold text-blue-800 mb-1">Analisa Cepat:</p>
                        <p>${report.transactionsCount > 0 ? `Rata-rata penjualan per transaksi: ${window.formatRupiah(report.sales / report.transactionsCount)}.` : 'Belum ada transaksi penjualan.'}</p>
                        <p>${report.profit > 0 ? `Kinerja sangat baik! Laba bersih positif.` : report.profit < 0 ? `Perhatikan pengeluaran! Laba bersih negatif.` : `Belum ada laba tercatat.`}</p>
                    </div>

                    <button onclick="window.downloadReportPng('${title}')" class="mt-4 w-full py-2 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 transition duration-150 flex items-center justify-center space-x-2">
                        <span>üíæ Download PNG</span> <span class="text-lg">üñºÔ∏è</span>
                    </button>
                </div>
            `;

            return `
                <div class="pb-6">
                    <h2 class="text-2xl font-extrabold text-gray-800 mb-4">Laporan Penjualan & Keuangan</h2>
                    ${reportCards('Laporan Harian', dailyReport)}
                    ${reportCards('Laporan Mingguan', weeklyReport)}
                    ${reportCards('Laporan Bulanan', monthlyReport)}

                    <div class="mt-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-3">Detail Transaksi Terbaru</h3>
                        <div class="space-y-2 max-h-60 overflow-y-scroll p-2 bg-gray-50 rounded-lg border border-gray-200">
                            ${transactions.length > 0 ? transactions.slice(0, 10).map(t => `
                                <div class="bg-white p-3 rounded-md shadow-sm flex justify-between items-center">
                                    <div>
                                        <p class="font-semibold text-gray-800">#${t.id.substring(0, 8)}</p>
                                        <p class="text-xs text-gray-500">${new Date(t.timestamp).toLocaleDateString()} ${new Date(t.timestamp).toLocaleTimeString()}</p>
                                    </div>
                                    <span class="font-bold text-emerald-600">${window.formatRupiah(t.total)}</span>
                                </div>
                            `).join('') : '<p class="text-center text-gray-500">Tidak ada transaksi.</p>'}
                        </div>
                    </div>
                </div>
            `;
        };

        /** Render Tampilan Halaman Pengaturan */
        window.renderSettings = () => {
            const { settings, userId } = window.appState;
            const logoPreview = settings.logoUrl ? `<img src="${settings.logoUrl}" alt="Logo Toko" class="w-16 h-16 object-contain rounded-full border-2 border-emerald-500 p-1 mb-2">` : '<div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center text-gray-500 mb-2">LOGO</div>';

            return `
                <div class="pb-6">
                    <h2 class="text-2xl font-extrabold text-gray-800 mb-6">Pengaturan Toko & Akun</h2>

                    <!-- Display User ID for database reference -->
                    <div class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <p class="text-xs font-semibold text-yellow-800">ID Pengguna (Database):</p>
                        <p class="break-all text-sm text-yellow-700">${userId || 'Memuat...'}</p>
                        <p class="text-xs text-yellow-600 mt-1">Gunakan ID ini untuk referensi data Anda.</p>
                    </div>

                    <!-- Form Pengaturan Toko -->
                    <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-200 mb-6">
                        <h3 class="text-xl font-bold text-emerald-600 mb-4 flex items-center space-x-2">
                            <span>üè†</span> <span>Informasi Toko</span>
                        </h3>
                        <form id="store-settings-form" onsubmit="window.saveSettings(event)">
                            <div class="mb-4">
                                ${logoPreview}
                                <label for="logo-upload" class="block text-sm font-medium text-gray-700">Logo Toko (URL Gambar)</label>
                                <input type="text" id="logo-url" value="${settings.logoUrl || ''}" placeholder="Paste URL gambar logo (misal: https://...)" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                            </div>
                            <div class="mb-4">
                                <label for="store-name" class="block text-sm font-medium text-gray-700">Nama Toko</label>
                                <input type="text" id="store-name" value="${settings.storeName || ''}" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                            </div>
                            <div class="mb-4">
                                <label for="cashier-name" class="block text-sm font-medium text-gray-700">Nama Kasir</label>
                                <input type="text" id="cashier-name" value="${settings.cashierName || ''}" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                            </div>
                            <div class="mb-4">
                                <label for="address" class="block text-sm font-medium text-gray-700">Alamat</label>
                                <textarea id="address" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">${settings.address || ''}</textarea>
                            </div>
                            <button type="submit" class="w-full py-3 bg-emerald-600 text-white font-semibold rounded-lg hover:bg-emerald-700 transition duration-150">
                                Simpan Pengaturan
                            </button>
                        </form>
                    </div>

                    <!-- Database Import/Export -->
                    <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-200">
                        <h3 class="text-xl font-bold text-red-600 mb-4 flex items-center space-x-2">
                            <span>üíæ</span> <span>Database (Unduh & Unggah)</span>
                        </h3>
                        <p class="text-sm text-gray-600 mb-3">Unduh semua data (Pengaturan, Produk, Transaksi, Kas Kecil) sebagai file JSON. Data dapat diunggah kembali di kemudian hari.</p>
                        <div class="space-y-3">
                            <button onclick="window.downloadDatabase()" class="w-full py-3 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition duration-150">
                                UNDUH Semua Data
                            </button>
                            <input type="file" id="upload-db-file" accept=".json" class="hidden" onchange="window.handleDatabaseUpload(event)">
                            <button onclick="document.getElementById('upload-db-file').click()" class="w-full py-3 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition duration-150">
                                UNGGAH Data JSON
                            </button>
                            <small class="text-red-500 block">PERINGATAN: Mengunggah data akan menimpa data yang ada!</small>
                        </div>
                    </div>
                </div>
            `;
        };

        /** Render Tampilan Halaman Input/Output (Petty Cash) */
        window.renderPettyCash = () => {
            const { pettyCash } = window.appState;

            const listHtml = pettyCash.map(item => `
                <div class="flex justify-between items-center p-3 border-b last:border-b-0 ${item.type === 'expense' ? 'bg-red-50' : 'bg-green-50'} rounded-lg shadow-sm">
                    <div>
                        <p class="font-bold text-gray-800">${item.description}</p>
                        <p class="text-xs text-gray-500">${item.type === 'income' ? 'Pemasukan' : 'Pengeluaran'} | ${new Date(item.timestamp).toLocaleDateString()}</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="font-extrabold ${item.type === 'expense' ? 'text-red-600' : 'text-green-600'}">
                            ${item.type === 'expense' ? '-' : ''}${window.formatRupiah(item.amount)}
                        </span>
                        <button onclick="window.deletePettyCash('${item.id}')" class="text-gray-500 hover:text-red-500">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');

            return `
                <div class="pb-6">
                    <h2 class="text-2xl font-extrabold text-gray-800 mb-4">Input & Pengeluaran (Kas Kecil)</h2>

                    <!-- Form Tambah Input/Output -->
                    <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-200 mb-6">
                        <h3 class="text-xl font-bold text-blue-600 mb-4 flex items-center space-x-2">
                            <span>üí∏</span> <span>Tambah Item</span>
                        </h3>
                        <form id="petty-cash-form" onsubmit="window.addPettyCash(event)">
                            <div class="mb-4">
                                <label for="pc-type" class="block text-sm font-medium text-gray-700">Jenis</label>
                                <select id="pc-type" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                    <option value="income">Pemasukan (di luar kasir)</option>
                                    <option value="expense">Pengeluaran (operasional)</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label for="pc-amount" class="block text-sm font-medium text-gray-700">Jumlah (Rp)</label>
                                <input type="number" id="pc-amount" required min="1" placeholder="Masukkan jumlah" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div class="mb-4">
                                <label for="pc-description" class="block text-sm font-medium text-gray-700">Keterangan</label>
                                <input type="text" id="pc-description" required placeholder="Deskripsi pemasukan/pengeluaran" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <button type="submit" class="w-full py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150">
                                Catat
                            </button>
                        </form>
                    </div>

                    <!-- Daftar Item Kas Kecil -->
                    <div class="mt-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-3">Riwayat Kas Kecil</h3>
                        <div class="space-y-3 max-h-96 overflow-y-scroll p-2 bg-gray-50 rounded-lg border border-gray-200">
                            ${listHtml.length > 0 ? listHtml : '<p class="text-center text-gray-500 p-4">Belum ada catatan kas kecil.</p>'}
                        </div>
                    </div>
                </div>
            `;
        };

        /** Render Tampilan Halaman Produk */
        window.renderProducts = () => {
            const { products } = window.appState;

            const listHtml = products.map(product => `
                <div class="flex justify-between items-center p-3 bg-white rounded-lg shadow-sm border border-gray-200">
                    <div>
                        <p class="font-bold text-gray-800">${product.name}</p>
                        <p class="text-sm text-emerald-600">${window.formatRupiah(product.price)}</p>
                        <p class="text-xs text-gray-500">Barcode: ${product.barcode || 'N/A'}</p>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="window.editProduct('${product.id}')" class="text-blue-500 hover:text-blue-700 p-2">
                            ‚úèÔ∏è
                        </button>
                        <button onclick="window.deleteProduct('${product.id}')" class="text-red-500 hover:text-red-700 p-2">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            `).join('');

            return `
                <div class="pb-6">
                    <h2 class="text-2xl font-extrabold text-gray-800 mb-4">Manajemen Produk</h2>

                    <!-- Form Tambah/Edit Produk -->
                    <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-200 mb-6">
                        <h3 id="product-form-title" class="text-xl font-bold text-purple-600 mb-4 flex items-center space-x-2">
                            <span>‚ûï</span> <span>Tambah Produk Baru</span>
                        </h3>
                        <form id="product-form" onsubmit="window.saveProduct(event)">
                            <input type="hidden" id="product-id" value="">
                            <div class="mb-4">
                                <label for="product-name" class="block text-sm font-medium text-gray-700">Nama Produk</label>
                                <input type="text" id="product-name" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                            </div>
                            <div class="mb-4">
                                <label for="product-price" class="block text-sm font-medium text-gray-700">Harga Jual (Rp)</label>
                                <input type="number" id="product-price" required min="1" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                            </div>
                            <div class="mb-4">
                                <label for="product-barcode" class="block text-sm font-medium text-gray-700">Barcode/Kode Angka</label>
                                <input type="text" id="product-barcode" placeholder="Opsional: Kode angka unik" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                            </div>
                            <button type="submit" id="product-submit-btn" class="w-full py-3 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition duration-150">
                                Simpan Produk
                            </button>
                            <button type="button" onclick="window.resetProductForm()" class="w-full py-2 mt-2 text-purple-600 font-semibold rounded-lg border border-purple-600 hover:bg-purple-50 transition duration-150 hidden" id="product-cancel-btn">
                                Batal Edit
                            </button>
                        </form>
                    </div>

                    <!-- Daftar Produk -->
                    <div class="mt-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-3">Daftar Produk (${products.length} Item)</h3>
                        <div class="space-y-3 max-h-96 overflow-y-scroll p-2 bg-gray-50 rounded-lg border border-gray-200">
                            ${listHtml.length > 0 ? listHtml : '<p class="text-center text-gray-500 p-4">Tidak ada produk.</p>'}
                        </div>
                    </div>
                </div>
            `;
        };

        /** Fungsi Utama untuk Merender Aplikasi Berdasarkan State */
        window.renderApp = () => {
            const contentArea = document.getElementById('content-area');
            let contentHtml = '';

            // Pastikan Auth sudah siap sebelum merender konten fungsional
            if (!window.appState.isAuthReady) {
                contentArea.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full p-8 text-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-emerald-500 mb-4"></div>
                        <p class="text-lg font-semibold text-gray-700">Memuat data pengguna dan toko...</p>
                        <p class="text-sm text-gray-500 mt-1">Harap tunggu sebentar.</p>
                        <p class="text-xs text-red-400 mt-4">ID: ${window.appState.userId || 'Anonim'}</p>
                    </div>
                `;
                return;
            }

            switch (window.appState.currentPage) {
                case 'POS':
                    contentHtml = window.renderPOS();
                    break;
                case 'Reports':
                    contentHtml = window.renderReports();
                    break;
                case 'Settings':
                    contentHtml = window.renderSettings();
                    break;
                case 'PettyCash':
                    contentHtml = window.renderPettyCash();
                    break;
                case 'Products':
                    contentHtml = window.renderProducts();
                    break;
                default:
                    contentHtml = `
                        <div class="p-4 text-center text-red-500">Halaman tidak ditemukan.</div>
                    `;
            }

            contentArea.innerHTML = contentHtml;

            // Aktifkan tombol navigasi yang sedang aktif
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('text-emerald-600', 'font-bold'));
            document.querySelector(`.nav-btn:nth-child(${['POS', 'PettyCash', 'Reports', 'Products'].indexOf(window.appState.currentPage) + 1})`).classList.add('text-emerald-600', 'font-bold');

            // Set fokus ke input barcode jika di halaman POS
            if (window.appState.currentPage === 'POS') {
                setTimeout(() => document.getElementById('barcode-input')?.focus(), 100);
            }
        };

        // --- Logic Produk ---

        /**
         * Menyimpan atau mengupdate produk ke Firestore.
         */
        window.saveProduct = async (event) => {
            event.preventDefault();
            const db = window.appState.db;
            const id = document.getElementById('product-id').value;
            const name = document.getElementById('product-name').value;
            const price = parseFloat(document.getElementById('product-price').value);
            const barcode = document.getElementById('product-barcode').value.trim();

            if (!name || isNaN(price) || price <= 0) return window.showModal('Gagal', 'Harga atau nama produk tidak valid.');

            const productData = { name, price, barcode };
            const productColRef = collection(db, window.getFirestorePath('products'));

            try {
                if (id) {
                    await setDoc(doc(db, window.getFirestorePath('products', id)), productData);
                    window.showModal('Sukses', `Produk <b>${name}</b> berhasil diupdate.`);
                } else {
                    await addDoc(productColRef, productData);
                    window.showModal('Sukses', `Produk <b>${name}</b> berhasil ditambahkan.`);
                }
                document.getElementById('product-form').reset();
                window.resetProductForm();
            } catch (error) {
                console.error("Error saving product:", error);
                window.showModal('Error', `Gagal menyimpan produk: ${error.message}`);
            }
        };

        /**
         * Mengisi form untuk edit produk.
         */
        window.editProduct = (id) => {
            const product = window.appState.products.find(p => p.id === id);
            if (!product) return;

            document.getElementById('product-id').value = product.id;
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-price').value = product.price;
            document.getElementById('product-barcode').value = product.barcode;
            document.getElementById('product-form-title').innerHTML = '‚úèÔ∏è Edit Produk';
            document.getElementById('product-submit-btn').textContent = 'Update Produk';
            document.getElementById('product-cancel-btn').classList.remove('hidden');
        };

        /**
         * Mereset form produk.
         */
        window.resetProductForm = () => {
            document.getElementById('product-id').value = '';
            document.getElementById('product-form').reset();
            document.getElementById('product-form-title').innerHTML = '<span>‚ûï</span> <span>Tambah Produk Baru</span>';
            document.getElementById('product-submit-btn').textContent = 'Simpan Produk';
            document.getElementById('product-cancel-btn').classList.add('hidden');
        };

        /**
         * Menghapus produk.
         */
        window.deleteProduct = async (id) => {
             const product = window.appState.products.find(p => p.id === id);
             const db = window.appState.db;

             if (!product) return;

             // Menggunakan modal kustom sebagai pengganti confirm()
             window.showModal('Konfirmasi Hapus', `
                 <p class="text-gray-700 mb-4">Yakin ingin menghapus produk <b>${product.name}</b>?</p>
                 <div class="flex justify-end space-x-3">
                     <button onclick="window.closeModal()" class="py-2 px-4 bg-gray-200 rounded-lg">Batal</button>
                     <button onclick="window._confirmDeleteProduct('${id}')" class="py-2 px-4 bg-red-600 text-white rounded-lg">Hapus</button>
                 </div>
             `, false);
        };

        window._confirmDeleteProduct = async (id) => {
            const db = window.appState.db;
             try {
                 await deleteDoc(doc(db, window.getFirestorePath('products', id)));
                 window.showModal('Sukses', 'Produk berhasil dihapus.');
             } catch (error) {
                 console.error("Error deleting product:", error);
                 window.showModal('Error', `Gagal menghapus produk: ${error.message}`);
             }
        }

        // --- Logic Kasir (POS) ---

        /**
         * Menangani input barcode atau pencarian produk.
         */
        window.handleBarcodeScan = (event) => {
            if (event.key === 'Enter') {
                const barcode = event.target.value.trim();
                event.target.value = ''; // Reset input
                if (!barcode) return;

                const product = window.appState.products.find(p => p.barcode === barcode || p.name.toLowerCase().includes(barcode.toLowerCase()));

                if (product) {
                    window.addToCart(product.id);
                } else {
                    window.showModal('Produk Tidak Ditemukan', `Produk dengan barcode/nama <b>"${barcode}"</b> tidak ada.`);
                }
            }
        };

        /**
         * Menambahkan produk ke keranjang.
         */
        window.addToCart = (productId) => {
            const product = window.appState.products.find(p => p.id === productId);
            if (!product) return;

            const existingItem = window.appState.cart.find(item => item.id === productId);

            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                window.appState.cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    quantity: 1,
                });
            }
            window.navigate('POS');
        };

        /**
         * Mengubah kuantitas item di keranjang.
         */
        window.updateCartQuantity = (productId, change) => {
            const item = window.appState.cart.find(item => item.id === productId);
            if (!item) return;

            item.quantity += change;

            if (item.quantity <= 0) {
                window.removeFromCart(productId);
            } else {
                window.navigate('POS');
            }
        };

        /**
         * Menghapus item dari keranjang.
         */
        window.removeFromCart = (productId) => {
            window.appState.cart = window.appState.cart.filter(item => item.id !== productId);
            window.navigate('POS');
        };

        /**
         * Memproses pembayaran (menampilkan modal pembayaran).
         */
        window.processPayment = () => {
            const total = window.appState.cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
            if (total <= 0) return window.showModal('Keranjang Kosong', 'Tambahkan produk ke keranjang untuk melanjutkan pembayaran.');

            const contentHtml = `
                <div class="space-y-4">
                    <div class="p-3 bg-emerald-100 rounded-lg">
                        <p class="text-sm font-semibold text-emerald-700">TOTAL BELANJA</p>
                        <p class="text-3xl font-extrabold text-emerald-800">${window.formatRupiah(total)}</p>
                    </div>

                    <div>
                        <label for="paid-amount" class="block text-sm font-medium text-gray-700">Bayar (Rp)</label>
                        <input type="number" id="paid-amount" min="${total}" value="${total}" oninput="window.calculateChange()" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg text-2xl font-bold focus:ring-emerald-500 focus:border-emerald-500">
                    </div>

                    <div class="p-3 bg-gray-100 rounded-lg">
                        <p class="text-sm font-semibold text-gray-700">KEMBALIAN</p>
                        <p id="change-display" class="text-2xl font-extrabold text-blue-600">${window.formatRupiah(0)}</p>
                    </div>

                    <button onclick="window.finalizeTransaction(${total})" class="w-full py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-150">
                        Selesaikan Transaksi
                    </button>
                </div>
            `;
            window.showModal('Pembayaran', contentHtml);
            setTimeout(() => window.calculateChange(), 100);
        };

        /**
         * Menghitung dan menampilkan kembalian.
         */
        window.calculateChange = () => {
            const total = window.appState.cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
            const paid = parseFloat(document.getElementById('paid-amount').value) || 0;
            const change = paid - total;
            document.getElementById('change-display').textContent = window.formatRupiah(change > 0 ? change : 0);
            if (paid < total) {
                document.getElementById('paid-amount').classList.add('border-red-500', 'ring-red-500');
            } else {
                document.getElementById('paid-amount').classList.remove('border-red-500', 'ring-red-500');
            }
        };

        /**
         * Menyelesaikan transaksi dan menyimpan ke Firestore.
         */
        window.finalizeTransaction = async (total) => {
            const paid = parseFloat(document.getElementById('paid-amount').value) || 0;
            const change = paid - total;

            if (paid < total) {
                return window.showModal('Pembayaran Kurang', 'Jumlah pembayaran harus mencukupi total belanja.');
            }

            const transactionData = {
                items: JSON.parse(JSON.stringify(window.appState.cart)), // Salin keranjang
                total: total,
                paid: paid,
                change: change,
                timestamp: Date.now(),
                cashierName: window.appState.settings.cashierName || 'Kasir',
            };

            try {
                const db = window.appState.db;
                const transactionRef = await addDoc(collection(db, window.getFirestorePath('transactions')), transactionData);

                // Reset keranjang dan tampilkan struk
                window.appState.cart = [];
                window.closeModal();
                window.navigate('POS');
                window.showReceiptModal({ id: transactionRef.id, ...transactionData });

            } catch (error) {
                console.error("Error finalizing transaction:", error);
                window.showModal('Error Transaksi', `Gagal menyimpan transaksi: ${error.message}`);
            }
        };

        // --- Logic Struk ---

        /**
         * Membuat HTML untuk tampilan struk.
         */
        window.generateReceiptHtml = (transaction) => {
            const { settings } = window.appState;
            const datetime = new Date(transaction.timestamp).toLocaleString('id-ID', { dateStyle: 'short', timeStyle: 'short' });

            const itemsHtml = transaction.items.map(item => `
                <div class="flex">
                    <span class="w-1/2">${item.name}</span>
                    <span class="w-1/4 text-right">${item.quantity} x</span>
                    <span class="w-1/4 text-right">${window.formatRupiah(item.price * item.quantity)}</span>
                </div>
            `).join('');

            return `
                <div class="receipt-preview text-center mx-auto" id="receipt-area">
                    <p class="text-xs font-bold">${settings.storeName}</p>
                    <p class="text-xs">${settings.address}</p>
                    <p class="text-xs mb-2">Kasir: ${transaction.cashierName}</p>
                    <div class="border-t border-b border-dashed border-gray-500 py-1 mb-2">
                        <div class="flex justify-between text-xs">
                            <span>Tgl: ${datetime.split(',')[0]}</span>
                            <span>Jam: ${datetime.split(',')[1]}</span>
                        </div>
                        <p class="text-xs">TRX ID: ${transaction.id.substring(0, 15)}</p>
                    </div>

                    <!-- Item List -->
                    <div class="text-left text-xs mb-2 space-y-0.5">
                        ${itemsHtml}
                    </div>

                    <div class="border-t border-dashed border-gray-500 pt-1 mb-2 text-xs text-right">
                        <div class="flex justify-between font-semibold">
                            <span>TOTAL</span>
                            <span>${window.formatRupiah(transaction.total)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>BAYAR</span>
                            <span>${window.formatRupiah(transaction.paid)}</span>
                        </div>
                        <div class="flex justify-between font-bold">
                            <span>KEMBALIAN</span>
                            <span>${window.formatRupiah(transaction.change)}</span>
                        </div>
                    </div>

                    <p class="text-xs mt-3">*** TERIMA KASIH ***</p>
                </div>
            `;
        };

        /**
         * Menampilkan modal preview struk dan opsi cetak/simpan.
         */
        window.showReceiptModal = (transaction) => {
            const receiptHtml = window.generateReceiptHtml(transaction);

            const contentHtml = `
                <div class="flex flex-col items-center">
                    <p class="text-green-600 font-bold mb-3">Transaksi Selesai!</p>
                    ${receiptHtml}
                    <div class="mt-4 w-full space-y-2">
                        <button onclick="window.printReceipt()" class="w-full py-2 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 flex items-center justify-center space-x-2">
                            <span>üñ®Ô∏è Cetak Struk</span>
                        </button>
                        <button onclick="window.downloadReceiptPng()" class="w-full py-2 bg-emerald-500 text-white font-semibold rounded-lg hover:bg-emerald-600 flex items-center justify-center space-x-2">
                            <span>üñºÔ∏è Simpan PNG</span>
                        </button>
                        <button onclick="window.shareReceiptText(event)" class="w-full py-2 bg-yellow-500 text-white font-semibold rounded-lg hover:bg-yellow-600 flex items-center justify-center space-x-2">
                            <span>üîó Bagikan Teks</span>
                        </button>
                    </div>
                </div>
            `;
            window.showModal('Preview Struk', contentHtml, true);
        };

        /**
         * Mencetak struk.
         */
        window.printReceipt = () => {
            const receiptArea = document.getElementById('receipt-area');
            const printExportArea = document.getElementById('print-export-area');

            // Salin konten struk ke area print tersembunyi
            printExportArea.innerHTML = receiptArea.outerHTML;

            // Cetak
            window.print();

            // Bersihkan setelah cetak
            setTimeout(() => printExportArea.innerHTML = '', 500);
        };

        /**
         * Menyimpan struk sebagai PNG.
         */
        window.downloadReceiptPng = () => {
            const receiptArea = document.getElementById('receipt-area');
            window.downloadElementAsPng(receiptArea, 'struk_kasir');
        };

        /**
         * Membagikan struk sebagai teks.
         */
        window.shareReceiptText = (event) => {
            const receiptArea = document.getElementById('receipt-area');
            const textContent = receiptArea.innerText;

            if (navigator.share) {
                navigator.share({
                    title: 'Struk Belanja ArKasir',
                    text: textContent,
                }).catch((error) => console.error('Error sharing', error));
            } else if (navigator.clipboard && navigator.clipboard.writeText) {
                // Clipboard fallback
                navigator.clipboard.writeText(textContent)
                    .then(() => {
                        event.target.textContent = '‚úÖ Teks Disalin!';
                        setTimeout(() => event.target.textContent = 'üîó Bagikan Teks', 2000);
                    })
                    .catch(err => {
                        console.error('Failed to copy: ', err);
                        window.showModal('Gagal', 'Gagal menyalin teks struk.');
                    });
            } else {
                 // Fallback for older browsers (using execCommand)
                 const textarea = document.createElement('textarea');
                 textarea.value = textContent;
                 document.body.appendChild(textarea);
                 textarea.select();
                 try {
                     document.execCommand('copy');
                     event.target.textContent = '‚úÖ Teks Disalin!';
                     setTimeout(() => event.target.textContent = 'üîó Bagikan Teks', 2000);
                 } catch (err) {
                     window.showModal('Gagal', 'Gagal menyalin teks struk.');
                 }
                 document.body.removeChild(textarea);
            }
        };

        // --- Logic Petty Cash ---

        /**
         * Menambahkan catatan kas kecil (pemasukan/pengeluaran).
         */
        window.addPettyCash = async (event) => {
            event.preventDefault();
            const db = window.appState.db;
            const type = document.getElementById('pc-type').value;
            const amount = parseFloat(document.getElementById('pc-amount').value);
            const description = document.getElementById('pc-description').value.trim();

            if (isNaN(amount) || amount <= 0 || !description) return window.showModal('Gagal', 'Jumlah atau keterangan tidak valid.');

            const pcData = {
                type,
                amount,
                description,
                timestamp: Date.now(),
            };

            try {
                await addDoc(collection(db, window.getFirestorePath('petty_cash')), pcData);
                window.showModal('Sukses', `Catatan ${type === 'income' ? 'Pemasukan' : 'Pengeluaran'} berhasil disimpan.`);
                document.getElementById('petty-cash-form').reset();
            } catch (error) {
                console.error("Error adding petty cash:", error);
                window.showModal('Error', `Gagal mencatat: ${error.message}`);
            }
        };

        /**
         * Menghapus catatan kas kecil.
         */
        window.deletePettyCash = async (id) => {
             const item = window.appState.pettyCash.find(i => i.id === id);
             const db = window.appState.db;

             if (!item) return;

             // Menggunakan modal kustom sebagai pengganti confirm()
             window.showModal('Konfirmasi Hapus', `
                 <p class="text-gray-700 mb-4">Yakin ingin menghapus catatan <b>${item.description}</b> (${window.formatRupiah(item.amount)})?</p>
                 <div class="flex justify-end space-x-3">
                     <button onclick="window.closeModal()" class="py-2 px-4 bg-gray-200 rounded-lg">Batal</button>
                     <button onclick="window._confirmDeletePettyCash('${id}')" class="py-2 px-4 bg-red-600 text-white rounded-lg">Hapus</button>
                 </div>
             `, false);
        };

        window._confirmDeletePettyCash = async (id) => {
            const db = window.appState.db;
             try {
                 await deleteDoc(doc(db, window.getFirestorePath('petty_cash', id)));
                 window.showModal('Sukses', 'Catatan berhasil dihapus.');
             } catch (error) {
                 console.error("Error deleting petty cash:", error);
                 window.showModal('Error', `Gagal menghapus catatan: ${error.message}`);
             }
        }

        // --- Logic Laporan ---

        /**
         * Menghitung laporan keuangan berdasarkan periode.
         * @param {Array} transactions - Daftar transaksi.
         * @param {Array} pettyCash - Daftar kas kecil.
         * @param {string} period - 'daily', 'weekly', 'monthly'.
         * @param {Date} startDate - Tanggal mulai (opsional untuk weekly/monthly).
         */
        window.generateReport = (transactions, pettyCash, period, startDate = null) => {
            const now = Date.now();
            let startBoundary = 0;

            if (period === 'daily') {
                const startOfDay = new Date();
                startOfDay.setHours(0, 0, 0, 0);
                startBoundary = startOfDay.getTime();
            } else if (period === 'weekly') {
                startBoundary = startDate ? startDate.getTime() : 0;
            } else if (period === 'monthly') {
                startBoundary = startDate ? startDate.getTime() : 0;
            } else {
                startBoundary = 0; // Semua data
            }

            const filteredTransactions = transactions.filter(t => t.timestamp >= startBoundary && t.timestamp <= now);
            const filteredPettyCash = pettyCash.filter(pc => pc.timestamp >= startBoundary && pc.timestamp <= now);

            const sales = filteredTransactions.reduce((sum, t) => sum + t.total, 0);
            const income = filteredPettyCash.filter(pc => pc.type === 'income').reduce((sum, pc) => sum + pc.amount, 0);
            const expense = filteredPettyCash.filter(pc => pc.type === 'expense').reduce((sum, pc) => sum + pc.amount, 0);
            const profit = (sales + income) - expense;

            return {
                sales,
                income,
                expense,
                profit,
                transactionsCount: filteredTransactions.length,
            };
        };

        /**
         * Men-download laporan sebagai PNG menggunakan html2canvas.
         */
        window.downloadReportPng = (reportTitle) => {
            const reportContent = document.getElementById('content-area');

            // Hapus tombol download agar tidak ikut ter-capture
            const buttons = reportContent.querySelectorAll('button');
            buttons.forEach(btn => {
                if (btn.textContent.includes('Download PNG')) {
                    btn.style.display = 'none';
                }
            });

            // Cari card laporan yang sesuai dengan judul
            let targetCard = null;
            reportContent.querySelectorAll('.bg-white.p-5').forEach(card => {
                if (card.querySelector('h3').textContent.trim() === reportTitle) {
                    targetCard = card;
                }
            });

            if (!targetCard) {
                window.showModal('Error', 'Konten laporan tidak ditemukan.');
                return;
            }

            window.downloadElementAsPng(targetCard, reportTitle.toLowerCase().replace(/\s/g, '_'));

            // Kembalikan tombol download
            buttons.forEach(btn => {
                if (btn.textContent.includes('Download PNG')) {
                    btn.style.display = 'flex';
                }
            });
        };

        // --- Logic Pengaturan & Database ---

        /**
         * Menyimpan pengaturan toko ke Firestore.
         */
        window.saveSettings = async (event) => {
            event.preventDefault();
            const db = window.appState.db;
            const settingsDocRef = doc(db, window.getFirestorePath('settings', 'storeInfo'));

            const newSettings = {
                storeName: document.getElementById('store-name').value.trim(),
                cashierName: document.getElementById('cashier-name').value.trim(),
                address: document.getElementById('address').value.trim(),
                logoUrl: document.getElementById('logo-url').value.trim(),
            };

            try {
                await setDoc(settingsDocRef, newSettings, { merge: true });
                window.showModal('Sukses', 'Pengaturan toko berhasil disimpan!');
            } catch (error) {
                console.error("Error saving settings:", error);
                window.showModal('Error', `Gagal menyimpan pengaturan: ${error.message}`);
            }
        };

        /**
         * Mengunduh semua data dari Firestore sebagai JSON.
         */
        window.downloadDatabase = async () => {
            const db = window.appState.db;
            const userId = window.appState.userId;
            if (!userId) return window.showModal('Gagal', 'ID Pengguna belum siap.');

            const data = {};
            const collectionsToExport = ['settings', 'products', 'transactions', 'petty_cash'];

            try {
                window.showModal('Mengunduh Data', '<p class="text-center">Mohon tunggu, sedang mengambil semua data dari database...</p>', false);

                // 1. Ambil Settings (Dokumen)
                const settingsDocRef = doc(db, window.getFirestorePath('settings', 'storeInfo'));
                const settingsSnap = await getDoc(settingsDocRef);
                data.settings = settingsSnap.exists() ? settingsSnap.data() : {};

                // 2. Ambil Koleksi
                for (const colName of ['products', 'transactions', 'petty_cash']) {
                    const colRef = collection(db, window.getFirestorePath(colName));
                    const colSnap = await getDocs(colRef);
                    data[colName] = colSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }

                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `arkasir_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                window.showModal('Sukses', 'Data berhasil diunduh sebagai JSON!');

            } catch (error) {
                console.error("Error downloading database:", error);
                window.showModal('Error', `Gagal mengunduh data: ${error.message}`);
            }
        };

        /**
         * Menangani unggahan file JSON database.
         */
        window.handleDatabaseUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const uploadedData = JSON.parse(e.target.result);
                    window.showModal('Konfirmasi Unggah', `
                        <p class="text-gray-700 mb-4">Anda yakin ingin mengunggah dan menimpa SEMUA data yang ada dengan file ini?</p>
                        <div class="flex justify-end space-x-3">
                            <button onclick="window.closeModal()" class="py-2 px-4 bg-gray-200 rounded-lg">Batal</button>
                            <button onclick="window.uploadDatabase(JSON.parse('${JSON.stringify(uploadedData).replace(/'/g, "\\'")}'))" class="py-2 px-4 bg-red-600 text-white rounded-lg">Unggah & Timpa</button>
                        </div>
                    `, false);
                } catch (error) {
                    window.showModal('Error', 'Gagal memproses file. Pastikan itu adalah file JSON yang valid.');
                }
            };
            reader.readAsText(file);
        };

        /**
         * Mengunggah data ke Firestore.
         */
        window.uploadDatabase = async (data) => {
            const db = window.appState.db;
            window.closeModal(); // Tutup konfirmasi

            try {
                window.showModal('Mengunggah Data', '<p class="text-center">Mohon tunggu, sedang mengunggah dan menimpa data...</p>', false);

                await runTransaction(db, async (transaction) => {
                    // 1. Settings
                    if (data.settings) {
                        const settingsDocRef = doc(db, window.getFirestorePath('settings', 'storeInfo'));
                        transaction.set(settingsDocRef, data.settings);
                    }

                    // 2. Collections (Hapus & Tulis Ulang) - HATI-HATI: Hapus semua dokumen yang ada
                    const collectionsToImport = ['products', 'transactions', 'petty_cash'];

                    for (const colName of collectionsToImport) {
                        // Ambil dan hapus semua dokumen yang ada
                        const colRef = collection(db, window.getFirestorePath(colName));
                        const existingDocs = await getDocs(colRef);
                        existingDocs.forEach(d => transaction.delete(d.ref));

                        // Tulis ulang dokumen dari file yang diupload
                        if (data[colName] && Array.isArray(data[colName])) {
                             for (const item of data[colName]) {
                                 // Gunakan ID asli jika tersedia, jika tidak biarkan Firestore membuat
                                 const itemRef = item.id ? doc(db, window.getFirestorePath(colName, item.id)) : doc(colRef);
                                 const itemData = { ...item };
                                 delete itemData.id; // Hapus properti ID agar tidak disimpan sebagai field
                                 transaction.set(itemRef, itemData);
                             }
                        }
                    }
                });

                window.showModal('Sukses', 'Data database berhasil diunggah dan ditimpa!');
            } catch (error) {
                console.error("Error uploading database:", error);
                window.showModal('Error', `Gagal mengunggah data: ${error.message}`);
            }
        };

        /**
         * Fungsi utilitas untuk men-download elemen HTML sebagai PNG.
         */
        window.downloadElementAsPng = (element, filename) => {
            html2canvas(element, { scale: 3 }).then(canvas => {
                const link = document.createElement('a');
                link.download = `${filename}_${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL('image/png');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.showModal('Sukses', `File <b>${filename}.png</b> berhasil disimpan.`);
            }).catch(error => {
                console.error('Error generating PNG:', error);
                window.showModal('Error', `Gagal membuat PNG: ${error.message}`);
            });
        };

        // Mulai aplikasi saat window selesai dimuat
        window.onload = () => {
             window.renderApp();
        };
    </script>
</body>
</html>

