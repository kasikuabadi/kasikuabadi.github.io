<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARKASIR PRO - Kasir Mobile POS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        /* Menggunakan Font Inter dan Montserrat */
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Inter:wght@300;400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; }

        .arkasir-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 900;
            letter-spacing: 2px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        /* Style untuk QuaggaJS (Area Scan) */
        #scanner-container {
            width: 100%;
            height: 300px;
            position: relative;
            overflow: hidden;
            border-radius: 8px;
            margin-bottom: 1rem;
            background-color: #000;
        }

        #scanner-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }
        #scanner-container canvas.drawingBuffer {
            position: absolute;
            top: 0;
            left: 0;
        }

        /* Kustomisasi scrollbar */
        .overflow-y-scroll::-webkit-scrollbar { width: 4px; }
        .overflow-y-scroll::-webkit-scrollbar-thumb { background: #06b6d4; border-radius: 2px; }
        .overflow-y-scroll::-webkit-scrollbar-track { background: #e0f7fa; }

        /* Style untuk modal print/preview */
        .receipt-preview {
            width: 300px;
            padding: 10px;
            font-size: 10px;
            line-height: 1.3;
            background-color: white;
            color: #1f2937;
        }
        @media print {
            body > *:not(.print-area) { display: none !important; }
            .print-area {
                display: block;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                margin: 0;
                padding: 0;
                box-shadow: none;
            }
            .receipt-preview {
                width: 100%;
                font-size: 12px;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <div id="app" class="flex flex-col flex-grow max-w-md mx-auto w-full shadow-lg bg-white rounded-t-xl overflow-hidden">

        <header class="p-4 bg-cyan-600 text-white shadow-md flex justify-between items-center">
            <h1 class="text-xl arkasir-title">ARKASIR PRO</h1>
            <button onclick="navigate('Settings')" class="text-white hover:text-cyan-200 p-2 rounded-full transition duration-150">
                <span class="text-2xl">‚öôÔ∏è</span>
            </button>
        </header>

        <main id="content-area" class="flex-grow p-4 overflow-y-auto pb-20"></main>

        <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white shadow-2xl border-t border-gray-200 z-50">
            <div class="flex justify-around items-center h-16">
                <button onclick="navigate('POS')" class="nav-btn flex flex-col items-center justify-center p-2 text-sm text-gray-500 hover:text-cyan-600 transition duration-150">
                    <span class="text-2xl">üõí</span>
                    <span class="mt-0.5">Kasir</span>
                </button>
                <button onclick="navigate('PettyCash')" class="nav-btn flex flex-col items-center justify-center p-2 text-sm text-gray-500 hover:text-cyan-600 transition duration-150">
                    <span class="text-2xl">üí∞</span>
                    <span class="mt-0.5">Kas Kecil</span>
                </button>
                <button onclick="navigate('Reports')" class="nav-btn flex flex-col items-center justify-center p-2 text-sm text-gray-500 hover:text-cyan-600 transition duration-150">
                    <span class="text-2xl">üìä</span>
                    <span class="mt-0.5">Laporan</span>
                </button>
                <button onclick="navigate('Products')" class="nav-btn flex flex-col items-center justify-center p-2 text-sm text-gray-500 hover:text-cyan-600 transition duration-150">
                    <span class="text-2xl">üì¶</span>
                    <span class="mt-0.5">Produk</span>
                </button>
            </div>
        </nav>

    </div>

    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
        <div id="modal-content" class="bg-white rounded-xl shadow-2xl m-4 max-w-sm w-full p-6">
            </div>
    </div>

    <div id="print-export-area" class="fixed top-0 left-0 opacity-0 -z-50 print-area"></div>

    <script>
        // Data Default untuk inisialisasi awal
        const DEFAULT_SETTINGS = { storeName: 'TOKO ANDA PRO', cashierName: 'Kasir Utama', address: 'Alamat Toko Anda' };
        const DEFAULT_PRODUCTS = [
            { id: 'prod1', name: 'Kopi Susu', price: 18000, barcode: '12345' },
            { id: 'prod2', name: 'Roti Panggang', price: 15000, barcode: '67890' },
            { id: 'prod3', name: 'Air Mineral 600ml', price: 5000, barcode: '11122' },
        ];
        
        // Global State Management
        window.appState = {
            settings: DEFAULT_SETTINGS,
            products: DEFAULT_PRODUCTS,
            cart: [],
            transactions: [],
            pettyCash: [],
            currentPage: 'POS',
            scanTarget: null, 
        };

        // --- Local Storage Management ---
        function loadFromLocalStorage() {
            const storedSettings = localStorage.getItem('arkasir_settings');
            const storedProducts = localStorage.getItem('arkasir_products');
            const storedTransactions = localStorage.getItem('arkasir_transactions');
            const storedPettyCash = localStorage.getItem('arkasir_pettyCash');

            if (storedSettings) window.appState.settings = { ...window.appState.settings, ...JSON.parse(storedSettings) };
            if (storedProducts) window.appState.products = JSON.parse(storedProducts);
            if (storedTransactions) window.appState.transactions = JSON.parse(storedTransactions);
            if (storedPettyCash) window.appState.pettyCash = JSON.parse(storedPettyCash);
        }

        function saveToLocalStorage() {
            localStorage.setItem('arkasir_settings', JSON.stringify(window.appState.settings));
            localStorage.setItem('arkasir_products', JSON.stringify(window.appState.products));
            localStorage.setItem('arkasir_transactions', JSON.stringify(window.appState.transactions));
            localStorage.setItem('arkasir_pettyCash', JSON.stringify(window.appState.pettyCash));
        }

        loadFromLocalStorage();

        // --- Global Helper Functions ---

        window.navigate = (page) => {
            window.appState.currentPage = page;
            renderApp();
        };

        window.formatRupiah = (number) => {
            if (isNaN(number) || number === null) return 'Rp 0';
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number);
        };

        window.showModal = (title, contentHtml, showClose = true) => {
            const modalBackdrop = document.getElementById('modal-backdrop');
            const modalContent = document.getElementById('modal-content');

            modalContent.innerHTML = `
                <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-200">
                    <h3 class="text-lg font-bold text-cyan-600">${title}</h3>
                    ${showClose ? `<button onclick="window.closeModal()" class="text-gray-400 hover:text-gray-600">
                        <span class="text-xl">‚úï</span>
                    </button>` : ''}
                </div>
                ${contentHtml}
            `;
            modalBackdrop.classList.remove('hidden');
            modalBackdrop.classList.add('flex');
        };

        window.closeModal = () => {
            const modalBackdrop = document.getElementById('modal-backdrop');
            modalBackdrop.classList.add('hidden');
            modalBackdrop.classList.remove('flex');
            // Pastikan QuaggaJS dihentikan saat modal ditutup
            if (window.Quagga) {
                try {
                    Quagga.stop();
                } catch (e) { /* ignore */ }
            }
        };
        
        // --- Logic Barcode Scanning (Diperbarui untuk Otomatis) ---

        window.openBarcodeScanner = (targetPage) => {
            window.showModal('Scan Barcode', `
                <div id="scanner-container">
                    <canvas class="drawingBuffer" style="position: absolute; top: 0; left: 0;"></canvas>
                </div>
                <p id="scanner-status" class="text-center text-sm text-gray-500 mt-2">Memuat kamera...</p>
                <div class="flex justify-end mt-4">
                    <button onclick="window.closeModal()" class="py-2 px-4 bg-red-500 text-white rounded-lg hover:bg-red-600">
                        Stop Scan
                    </button>
                </div>
            `, false);
            
            window.appState.scanTarget = targetPage;
            setTimeout(window.startQuaggaScanner, 500);
        };

        window.startQuaggaScanner = () => {
            const statusElement = document.getElementById('scanner-status');
            
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#scanner-container'),
                    constraints: {
                        facingMode: "environment", // Kamera belakang
                        width: { min: 640 },
                        height: { min: 480 }
                    },
                },
                decoder: {
                    readers: ["ean_reader", "ean_8_reader", "code_128_reader", "upc_reader", "code_39_reader"],
                    multiple: false,
                }
            }, function(err) {
                if (err) {
                    console.error(err);
                    statusElement.textContent = 'Gagal memuat kamera. Cek izin browser.';
                    return;
                }
                statusElement.textContent = 'Arahkan kamera ke barcode...';
                Quagga.start();
            });

            Quagga.onDetected(function(result) {
                const barcode = result.codeResult.code;
                
                // 1. HENTIKAN SCANNER SEGERA
                Quagga.stop(); 
                
                // 2. TUTUP MODAL
                window.closeModal(); 
                
                // 3. PROSES BARCODE SESUAI HALAMAN
                if (window.appState.scanTarget === 'POS') {
                    window.handleScannedBarcodePOS(barcode);
                } else if (window.appState.scanTarget === 'Products') {
                    window.handleScannedBarcodeProducts(barcode);
                }
            });

            // Optional: Visual Feedback (Jika dibutuhkan)
            // Quagga.onProcessed(function(result) {
            //     var drawingCtx = Quagga.canvas.ctx.overlay, drawingCanvas = Quagga.canvas.dom.overlay;
            //     if (result) { /* ... draw lines ... */ }
            // });
        };

        window.handleScannedBarcodePOS = (barcode) => {
            const product = window.appState.products.find(p => p.barcode === barcode);
            
            if (product) {
                window.addToCart(product.id);
                
                window.showModal('Scan Sukses!', `Produk <b>${product.name}</b> ditambahkan.`);
                
                setTimeout(() => {
                    window.closeModal();
                }, 1000); 

            } else {
                window.showModal('Produk Tidak Ditemukan', `Barcode <b>${barcode}</b> tidak cocok dengan produk manapun.`);
            }
        };

        window.handleScannedBarcodeProducts = (barcode) => {
            const barcodeInput = document.getElementById('product-barcode');
            if (barcodeInput) {
                barcodeInput.value = barcode;
                window.showModal('Barcode Terisi', `Barcode <b>${barcode}</b> berhasil diisi ke form Produk.`);
            }
        };


        // --- Logic Halaman POS (tetap sama) ---

        window.renderPOS = () => {
            const { products, cart } = window.appState;
            const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);

            const cartHtml = cart.length === 0
                ? '<p class="text-center text-gray-500 pt-10">Keranjang kosong. Tambahkan produk!</p>'
                : cart.map((item) => `
                    <div class="flex justify-between items-center p-2 border-b last:border-b-0">
                        <div class="flex-grow">
                            <p class="font-semibold text-gray-800">${item.name}</p>
                            <p class="text-xs text-gray-500">${window.formatRupiah(item.price)} x ${item.quantity}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="font-bold text-cyan-600">${window.formatRupiah(item.price * item.quantity)}</span>
                            <button onclick="window.updateCartQuantity('${item.id}', -1)" class="text-red-500 p-1 rounded-full text-lg">‚ûñ</button>
                            <button onclick="window.updateCartQuantity('${item.id}', 1)" class="text-green-500 p-1 rounded-full text-lg">‚ûï</button>
                            <button onclick="window.removeFromCart('${item.id}')" class="text-red-700 p-1 rounded-full text-lg">üóëÔ∏è</button>
                        </div>
                    </div>
                `).join('');

            const productListHtml = products.map(product => `
                <button onclick="window.addToCart('${product.id}')" class="bg-white p-3 rounded-lg shadow-sm hover:shadow-md transition duration-150 border border-gray-200 text-left">
                    <p class="font-bold text-gray-800">${product.name}</p>
                    <p class="text-sm text-cyan-600">${window.formatRupiah(product.price)}</p>
                </button>
            `).join('');

            return `
                <div class="flex flex-col h-full space-y-4">
                    <h2 class="text-2xl font-extrabold text-gray-800 mb-2">Kasir Cepat</h2>

                    <div class="sticky top-0 bg-white pt-1 pb-4 z-10 border-b border-gray-200">
                        <div class="flex items-center space-x-2">
                            <input type="text" id="barcode-input" onkeyup="window.handleBarcodeScan(event)" placeholder="Ketik Kode/Nama Produk" class="flex-grow p-3 border border-gray-300 rounded-l-lg focus:ring-cyan-500 focus:border-cyan-500">
                            <button onclick="window.openBarcodeScanner('POS')" class="p-3 bg-cyan-600 text-white rounded-r-lg hover:bg-cyan-700 transition duration-150 flex items-center">
                                <span class="text-xl">üì∑ Scan</span>
                            </button>
                        </div>
                        <small class="text-xs text-gray-500 mt-1 block">Tekan Enter untuk mencari cepat.</small>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mb-4 max-h-40 overflow-y-scroll p-2 bg-gray-50 rounded-lg">
                        ${productListHtml.length > 0 ? productListHtml : '<p class="col-span-2 text-center text-gray-500">Tambahkan produk di menu Produk.</p>'}
                    </div>

                    <div class="flex-grow bg-white border border-gray-200 rounded-lg shadow-inner overflow-y-scroll max-h-80">
                        ${cartHtml}
                    </div>

                    <div class="sticky bottom-0 bg-white p-4 -mx-4 border-t border-gray-200 shadow-xl">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-xl font-semibold text-gray-600">TOTAL</span>
                            <span class="text-3xl font-extrabold text-cyan-700">${window.formatRupiah(total)}</span>
                        </div>
                        <button onclick="window.processPayment()" ${cart.length === 0 ? 'disabled' : ''} class="w-full py-4 bg-cyan-600 text-white font-bold text-lg rounded-xl shadow-lg hover:bg-cyan-700 transition duration-150 disabled:bg-gray-400">
                            Bayar Sekarang
                        </button>
                    </div>
                </div>
            `;
        };
        // (addToCart, updateCartQuantity, removeFromCart, processPayment, finalizeTransaction, generateReceiptHtml, showReceiptModal, dll. sama seperti versi sebelumnya)
        
        window.handleBarcodeScan = (event) => {
            if (event.key === 'Enter') {
                const query = event.target.value.trim();
                event.target.value = '';
                if (!query) return;

                const product = window.appState.products.find(p => 
                    p.barcode === query || p.name.toLowerCase().includes(query.toLowerCase())
                );

                if (product) {
                    window.addToCart(product.id);
                } else {
                    window.showModal('Produk Tidak Ditemukan', `Produk dengan kode/nama <b>"${query}"</b> tidak ada.`);
                }
            }
        };

        window.addToCart = (productId) => {
            const product = window.appState.products.find(p => p.id === productId);
            if (!product) return;

            const existingItem = window.appState.cart.find(item => item.id === productId);

            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                window.appState.cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    quantity: 1,
                });
            }
            window.navigate('POS');
        };

        window.updateCartQuantity = (productId, change) => {
            const item = window.appState.cart.find(item => item.id === productId);
            if (!item) return;

            item.quantity += change;

            if (item.quantity <= 0) {
                window.removeFromCart(productId);
            } else {
                window.navigate('POS');
            }
        };

        window.removeFromCart = (productId) => {
            window.appState.cart = window.appState.cart.filter(item => item.id !== productId);
            window.navigate('POS');
        };

        window.processPayment = () => {
            const total = window.appState.cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
            if (total <= 0) return window.showModal('Keranjang Kosong', 'Tambahkan produk ke keranjang untuk melanjutkan pembayaran.');

            const contentHtml = `
                <div class="space-y-4">
                    <div class="p-3 bg-cyan-100 rounded-lg">
                        <p class="text-sm font-semibold text-cyan-700">TOTAL BELANJA</p>
                        <p class="text-3xl font-extrabold text-cyan-800">${window.formatRupiah(total)}</p>
                    </div>

                    <div>
                        <label for="paid-amount" class="block text-sm font-medium text-gray-700">Bayar (Rp)</label>
                        <input type="number" id="paid-amount" min="${total}" value="${total}" oninput="window.calculateChange(${total})" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg text-2xl font-bold focus:ring-cyan-500 focus:border-cyan-500">
                    </div>

                    <div class="p-3 bg-gray-100 rounded-lg">
                        <p class="text-sm font-semibold text-gray-700">KEMBALIAN</p>
                        <p id="change-display" class="text-2xl font-extrabold text-blue-600">${window.formatRupiah(0)}</p>
                    </div>

                    <button onclick="window.finalizeTransaction(${total})" class="w-full py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-150">
                        Selesaikan Transaksi
                    </button>
                </div>
            `;
            window.showModal('Pembayaran', contentHtml);
            setTimeout(() => window.calculateChange(total), 100);
        };

        window.calculateChange = (total) => {
            const paidInput = document.getElementById('paid-amount');
            const paid = parseFloat(paidInput.value) || 0;
            const change = paid - total;

            document.getElementById('change-display').textContent = window.formatRupiah(change > 0 ? change : 0);
            
            if (paid < total) {
                paidInput.classList.add('border-red-500', 'ring-red-500');
                paidInput.classList.remove('border-gray-300');
            } else {
                paidInput.classList.remove('border-red-500', 'ring-red-500');
                paidInput.classList.add('border-gray-300');
            }
        };

        window.finalizeTransaction = (total) => {
            const paid = parseFloat(document.getElementById('paid-amount').value) || 0;
            const change = paid - total;

            if (paid < total) {
                return window.showModal('Pembayaran Kurang', 'Jumlah pembayaran harus mencukupi total belanja.');
            }

            const transactionData = {
                items: JSON.parse(JSON.stringify(window.appState.cart)),
                total: total,
                paid: paid,
                change: change,
                timestamp: Date.now(),
                cashierName: window.appState.settings.cashierName || 'Kasir',
            };
            
            const transactionId = 'TRX-' + Date.now().toString().slice(-8);

            window.appState.transactions.unshift({ id: transactionId, ...transactionData });
            saveToLocalStorage();

            window.appState.cart = [];
            window.closeModal();
            window.navigate('POS');
            window.showReceiptModal({ id: transactionId, ...transactionData });
        };
        
        window.generateReceiptHtml = (transaction) => {
            const { settings } = window.appState;
            const datetime = new Date(transaction.timestamp).toLocaleString('id-ID', { dateStyle: 'short', timeStyle: 'short' });

            const itemsHtml = transaction.items.map(item => `
                <div class="flex">
                    <span class="w-1/2">${item.name}</span>
                    <span class="w-1/4 text-right">${item.quantity} x</span>
                    <span class="w-1/4 text-right">${window.formatRupiah(item.price * item.quantity)}</span>
                </div>
            `).join('');

            return `
                <div class="receipt-preview text-center mx-auto" id="receipt-area">
                    ${settings.logoUrl ? `<img src="${settings.logoUrl}" alt="Logo" class="mx-auto w-10 h-10 object-contain mb-1">` : ''}
                    <p class="text-xs font-bold">${settings.storeName}</p>
                    <p class="text-xs">${settings.address}</p>
                    <p class="text-xs mb-2">Kasir: ${transaction.cashierName}</p>
                    <div class="border-t border-b border-dashed border-gray-500 py-1 mb-2">
                        <div class="flex justify-between text-xs">
                            <span>Tgl: ${datetime.split(',')[0]}</span>
                            <span>Jam: ${datetime.split(',')[1]}</span>
                        </div>
                        <p class="text-xs">TRX ID: ${transaction.id}</p>
                    </div>

                    <div class="text-left text-xs mb-2 space-y-0.5">
                        ${itemsHtml}
                    </div>

                    <div class="border-t border-dashed border-gray-500 pt-1 mb-2 text-xs text-right">
                        <div class="flex justify-between font-semibold">
                            <span>TOTAL</span>
                            <span>${window.formatRupiah(transaction.total)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>BAYAR</span>
                            <span>${window.formatRupiah(transaction.paid)}</span>
                        </div>
                        <div class="flex justify-between font-bold">
                            <span>KEMBALIAN</span>
                            <span>${window.formatRupiah(transaction.change)}</span>
                        </div>
                    </div>

                    <p class="text-xs mt-3">*** TERIMA KASIH ***</p>
                </div>
            `;
        };

        window.showReceiptModal = (transaction) => {
            const receiptHtml = window.generateReceiptHtml(transaction);

            const contentHtml = `
                <div class="flex flex-col items-center">
                    <p class="text-green-600 font-bold mb-3">Transaksi Selesai!</p>
                    ${receiptHtml}
                    <div class="mt-4 w-full space-y-2">
                        <button onclick="window.printReceipt()" class="w-full py-2 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 flex items-center justify-center space-x-2">
                            <span>üñ®Ô∏è Cetak Struk</span>
                        </button>
                        <button onclick="window.downloadReceiptPng()" class="w-full py-2 bg-cyan-500 text-white font-semibold rounded-lg hover:bg-cyan-600 flex items-center justify-center space-x-2">
                            <span>üñºÔ∏è Simpan PNG</span>
                        </button>
                    </div>
                </div>
            `;
            window.showModal('Preview Struk', contentHtml, true);
        };
        
        window.printReceipt = () => {
            const receiptArea = document.getElementById('receipt-area');
            const printExportArea = document.getElementById('print-export-area');

            printExportArea.innerHTML = receiptArea.outerHTML;

            window.print();

            setTimeout(() => printExportArea.innerHTML = '', 500);
        };

        window.downloadReceiptPng = () => {
            const receiptArea = document.getElementById('receipt-area');
            window.downloadElementAsPng(receiptArea, 'struk_kasir');
        };

        // --- Logic Halaman Produk (tetap sama) ---

        window.renderProducts = () => {
            const { products } = window.appState;

            const listHtml = products.map(product => `
                <div class="flex justify-between items-center p-3 bg-white rounded-lg shadow-sm border border-gray-200">
                    <div>
                        <p class="font-bold text-gray-800">${product.name}</p>
                        <p class="text-sm text-cyan-600">${window.formatRupiah(product.price)}</p>
                        <p class="text-xs text-gray-500">Barcode: ${product.barcode || 'N/A'}</p>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="window.editProduct('${product.id}')" class="text-blue-500 hover:text-blue-700 p-2">
                            ‚úèÔ∏è
                        </button>
                        <button onclick="window.deleteProduct('${product.id}')" class="text-red-500 hover:text-red-700 p-2">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            `).join('');

            return `
                <div class="pb-6">
                    <h2 class="text-2xl font-extrabold text-gray-800 mb-4">Manajemen Produk</h2>

                    <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-200 mb-6">
                        <h3 id="product-form-title" class="text-xl font-bold text-purple-600 mb-4 flex items-center space-x-2">
                            <span>‚ûï</span> <span class="flex-grow">Tambah Produk Baru</span>
                        </h3>
                        <form id="product-form" onsubmit="window.saveProduct(event)">
                            <input type="hidden" id="product-id" value="">
                            <div class="mb-4">
                                <label for="product-name" class="block text-sm font-medium text-gray-700">Nama Produk</label>
                                <input type="text" id="product-name" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                            </div>
                            <div class="mb-4">
                                <label for="product-price" class="block text-sm font-medium text-gray-700">Harga Jual (Rp)</label>
                                <input type="number" id="product-price" required min="1" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                            </div>
                            <div class="mb-4">
                                <label for="product-barcode" class="block text-sm font-medium text-gray-700">Barcode/Kode Angka (Unik)</label>
                                <div class="flex">
                                    <input type="text" id="product-barcode" placeholder="Opsional: Kode angka unik" class="flex-grow p-3 border border-gray-300 rounded-l-lg focus:ring-purple-500 focus:border-purple-500">
                                    <button type="button" onclick="window.openBarcodeScanner('Products')" class="p-3 bg-purple-600 text-white rounded-r-lg hover:bg-purple-700 transition duration-150 flex items-center">
                                        <span class="text-xl">üì∑</span>
                                    </button>
                                </div>
                            </div>
                            <button type="submit" id="product-submit-btn" class="w-full py-3 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition duration-150">
                                Simpan Produk
                            </button>
                            <button type="button" onclick="window.resetProductForm()" class="w-full py-2 mt-2 text-purple-600 font-semibold rounded-lg border border-purple-600 hover:bg-purple-50 transition duration-150 hidden" id="product-cancel-btn">
                                Batal Edit
                            </button>
                        </form>
                    </div>

                    <div class="mt-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-3">Daftar Produk (${products.length} Item)</h3>
                        <div class="space-y-3 max-h-96 overflow-y-scroll p-2 bg-gray-50 rounded-lg border border-gray-200">
                            ${listHtml.length > 0 ? listHtml : '<p class="text-center text-gray-500 p-4">Tidak ada produk.</p>'}
                        </div>
                    </div>
                </div>
            `;
        };

        window.saveProduct = (event) => {
            event.preventDefault();
            const id = document.getElementById('product-id').value;
            const name = document.getElementById('product-name').value;
            const price = parseFloat(document.getElementById('product-price').value);
            const barcode = document.getElementById('product-barcode').value.trim();

            if (!name || isNaN(price) || price <= 0) return window.showModal('Gagal', 'Harga atau nama produk tidak valid.');

            const productData = { name, price, barcode };
            
            if (id) {
                const index = window.appState.products.findIndex(p => p.id === id);
                if (index !== -1) window.appState.products[index] = { id, ...productData };
                window.showModal('Sukses', `Produk <b>${name}</b> berhasil diupdate.`);
            } else {
                const newId = 'PROD-' + Date.now().toString().slice(-8);
                window.appState.products.push({ id: newId, ...productData });
                window.showModal('Sukses', `Produk <b>${name}</b> berhasil ditambahkan.`);
            }
            
            saveToLocalStorage();
            document.getElementById('product-form').reset();
            window.resetProductForm();
            renderApp();
        };

        window.editProduct = (id) => {
            const product = window.appState.products.find(p => p.id === id);
            if (!product) return;

            document.getElementById('product-id').value = product.id;
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-price').value = product.price;
            document.getElementById('product-barcode').value = product.barcode;
            document.getElementById('product-form-title').innerHTML = '‚úèÔ∏è Edit Produk';
            document.getElementById('product-submit-btn').textContent = 'Update Produk';
            document.getElementById('product-cancel-btn').classList.remove('hidden');
        };

        window.resetProductForm = () => {
            document.getElementById('product-id').value = '';
            document.getElementById('product-form').reset();
            document.getElementById('product-form-title').innerHTML = '<span>‚ûï</span> <span class="flex-grow">Tambah Produk Baru</span>';
            document.getElementById('product-submit-btn').textContent = 'Simpan Produk';
            document.getElementById('product-cancel-btn').classList.add('hidden');
        };

        window.deleteProduct = (id) => {
             const product = window.appState.products.find(p => p.id === id);
             if (!product) return;

             window.showModal('Konfirmasi Hapus', `
                 <p class="text-gray-700 mb-4">Yakin ingin menghapus produk <b>${product.name}</b>?</p>
                 <div class="flex justify-end space-x-3">
                     <button onclick="window.closeModal()" class="py-2 px-4 bg-gray-200 rounded-lg">Batal</button>
                     <button onclick="window._confirmDeleteProduct('${id}')" class="py-2 px-4 bg-red-600 text-white rounded-lg">Hapus</button>
                 </div>
             `, false);
        };

        window._confirmDeleteProduct = (id) => {
             window.appState.products = window.appState.products.filter(p => p.id !== id);
             saveToLocalStorage();
             window.showModal('Sukses', 'Produk berhasil dihapus.');
             renderApp();
        }

        // --- Logic Halaman Kas Kecil (tetap sama) ---

        window.renderPettyCash = () => {
            const { pettyCash } = window.appState;

            const listHtml = pettyCash.map(item => `
                <div class="flex justify-between items-center p-3 border-b last:border-b-0 ${item.type === 'expense' ? 'bg-red-50' : 'bg-green-50'} rounded-lg shadow-sm">
                    <div>
                        <p class="font-bold text-gray-800">${item.description}</p>
                        <p class="text-xs text-gray-500">${item.type === 'income' ? 'Pemasukan' : 'Pengeluaran'} | ${new Date(item.timestamp).toLocaleDateString()}</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="font-extrabold ${item.type === 'expense' ? 'text-red-600' : 'text-green-600'}">
                            ${item.type === 'expense' ? '-' : ''}${window.formatRupiah(item.amount)}
                        </span>
                        <button onclick="window.deletePettyCash('${item.id}')" class="text-gray-500 hover:text-red-500">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');

            return `
                <div class="pb-6">
                    <h2 class="text-2xl font-extrabold text-gray-800 mb-4">Input & Pengeluaran (Kas Kecil)</h2>

                    <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-200 mb-6">
                        <h3 class="text-xl font-bold text-blue-600 mb-4 flex items-center space-x-2">
                            <span>üí∏</span> <span>Tambah Item</span>
                        </h3>
                        <form id="petty-cash-form" onsubmit="window.addPettyCash(event)">
                            <div class="mb-4">
                                <label for="pc-type" class="block text-sm font-medium text-gray-700">Jenis</label>
                                <select id="pc-type" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                    <option value="income">Pemasukan (di luar kasir)</option>
                                    <option value="expense">Pengeluaran (operasional)</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label for="pc-amount" class="block text-sm font-medium text-gray-700">Jumlah (Rp)</label>
                                <input type="number" id="pc-amount" required min="1" placeholder="Masukkan jumlah" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div class="mb-4">
                                <label for="pc-description" class="block text-sm font-medium text-gray-700">Keterangan</label>
                                <input type="text" id="pc-description" required placeholder="Deskripsi pemasukan/pengeluaran" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <button type="submit" class="w-full py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150">
                                Catat
                            </button>
                        </form>
                    </div>

                    <div class="mt-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-3">Riwayat Kas Kecil</h3>
                        <div class="space-y-3 max-h-96 overflow-y-scroll p-2 bg-gray-50 rounded-lg border border-gray-200">
                            ${listHtml.length > 0 ? listHtml : '<p class="text-center text-gray-500 p-4">Belum ada catatan kas kecil.</p>'}
                        </div>
                    </div>
                </div>
            `;
        };

        window.addPettyCash = (event) => {
            event.preventDefault();
            const type = document.getElementById('pc-type').value;
            const amount = parseFloat(document.getElementById('pc-amount').value);
            const description = document.getElementById('pc-description').value.trim();

            if (isNaN(amount) || amount <= 0 || !description) return window.showModal('Gagal', 'Jumlah atau keterangan tidak valid.');

            const pcData = {
                id: 'PC-' + Date.now().toString().slice(-8),
                type,
                amount,
                description,
                timestamp: Date.now(),
            };
            
            window.appState.pettyCash.unshift(pcData);
            saveToLocalStorage();

            window.showModal('Sukses', `Catatan ${type === 'income' ? 'Pemasukan' : 'Pengeluaran'} berhasil disimpan.`);
            document.getElementById('petty-cash-form').reset();
            renderApp();
        };

        window.deletePettyCash = (id) => {
             const item = window.appState.pettyCash.find(i => i.id === id);
             if (!item) return;

             window.showModal('Konfirmasi Hapus', `
                 <p class="text-gray-700 mb-4">Yakin ingin menghapus catatan <b>${item.description}</b> (${window.formatRupiah(item.amount)})?</p>
                 <div class="flex justify-end space-x-3">
                     <button onclick="window.closeModal()" class="py-2 px-4 bg-gray-200 rounded-lg">Batal</button>
                     <button onclick="window._confirmDeletePettyCash('${id}')" class="py-2 px-4 bg-red-600 text-white rounded-lg">Hapus</button>
                 </div>
             `, false);
        };

        window._confirmDeletePettyCash = (id) => {
             window.appState.pettyCash = window.appState.pettyCash.filter(i => i.id !== id);
             saveToLocalStorage();
             window.showModal('Sukses', 'Catatan berhasil dihapus.');
             renderApp();
        }

        // --- Logic Halaman Laporan (tetap sama) ---

        window.generateReport = (transactions, pettyCash, period, startDate = null) => {
            const now = Date.now();
            let startBoundary = 0;

            if (period === 'daily') {
                const startOfDay = new Date();
                startOfDay.setHours(0, 0, 0, 0);
                startBoundary = startOfDay.getTime();
            } else if (period === 'weekly') {
                const startOfWeek = new Date();
                startOfWeek.setDate(startOfWeek.getDate() - (startOfWeek.getDay() || 7)); 
                startOfWeek.setHours(0, 0, 0, 0);
                startBoundary = startOfWeek.getTime();
            } else if (period === 'monthly') {
                const startOfMonth = new Date();
                startOfMonth.setDate(1);
                startOfMonth.setHours(0, 0, 0, 0);
                startBoundary = startOfMonth.getTime();
            } else if (startDate) {
                startBoundary = startDate.getTime();
            }

            const filteredTransactions = transactions.filter(t => t.timestamp >= startBoundary && t.timestamp <= now);
            const filteredPettyCash = pettyCash.filter(pc => pc.timestamp >= startBoundary && pc.timestamp <= now);

            const sales = filteredTransactions.reduce((sum, t) => sum + t.total, 0);
            const income = filteredPettyCash.filter(pc => pc.type === 'income').reduce((sum, pc) => sum + pc.amount, 0);
            const expense = filteredPettyCash.filter(pc => pc.type === 'expense').reduce((sum, pc) => sum + pc.amount, 0);
            const profit = (sales + income) - expense;

            return {
                sales, income, expense, profit, transactionsCount: filteredTransactions.length,
            };
        };

        window.renderReports = () => {
            const { transactions, pettyCash } = window.appState;
            const dailyReport = window.generateReport(transactions, pettyCash, 'daily');
            const weeklyReport = window.generateReport(transactions, pettyCash, 'weekly');
            const monthlyReport = window.generateReport(transactions, pettyCash, 'monthly');

            const reportCards = (title, report) => `
                <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-200 mb-4" id="${title.toLowerCase().replace(/\s/g, '_')}-card">
                    <h3 class="text-xl font-bold text-gray-800 mb-3">${title}</h3>
                    <div class="space-y-2 text-sm">
                        <p class="flex justify-between font-semibold"><span>Penjualan (Transaksi)</span><span class="text-cyan-600">${window.formatRupiah(report.sales)}</span></p>
                        <p class="flex justify-between font-semibold"><span>Pemasukan Lain</span><span class="text-green-600">${window.formatRupiah(report.income)}</span></p>
                        <p class="flex justify-between font-semibold"><span>Pengeluaran</span><span class="text-red-600">(${window.formatRupiah(report.expense)})</span></p>
                        <div class="pt-2 border-t border-gray-200">
                            <p class="flex justify-between text-lg font-extrabold"><span>Laba Bersih</span><span class="${report.profit >= 0 ? 'text-blue-600' : 'text-red-600'}">${window.formatRupiah(report.profit)}</span></p>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">${report.transactionsCount} Transaksi penjualan.</p>
                    <button onclick="window.downloadReportPng('${title.toLowerCase().replace(/\s/g, '_')}-card', '${title}')" class="mt-4 w-full py-2 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 transition duration-150 flex items-center justify-center space-x-2">
                        <span>üíæ Download PNG</span> <span class="text-lg">üñºÔ∏è</span>
                    </button>
                </div>
            `;

            return `
                <div class="pb-6">
                    <h2 class="text-2xl font-extrabold text-gray-800 mb-4">Laporan Penjualan & Keuangan</h2>
                    ${reportCards('Laporan Harian', dailyReport)}
                    ${reportCards('Laporan Mingguan', weeklyReport)}
                    ${reportCards('Laporan Bulanan', monthlyReport)}

                    <div class="mt-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-3">Detail Transaksi Terbaru</h3>
                        <div class="space-y-2 max-h-60 overflow-y-scroll p-2 bg-gray-50 rounded-lg border border-gray-200">
                            ${transactions.length > 0 ? transactions.slice(0, 10).map(t => `
                                <div class="bg-white p-3 rounded-md shadow-sm flex justify-between items-center">
                                    <div>
                                        <p class="font-semibold text-gray-800">#${t.id}</p>
                                        <p class="text-xs text-gray-500">${new Date(t.timestamp).toLocaleDateString()} ${new Date(t.timestamp).toLocaleTimeString()}</p>
                                    </div>
                                    <span class="font-bold text-cyan-600">${window.formatRupiah(t.total)}</span>
                                </div>
                            `).join('') : '<p class="text-center text-gray-500">Tidak ada transaksi.</p>'}
                        </div>
                    </div>
                </div>
            `;
        };

        // --- Logic Halaman Pengaturan (Ditambah Impor/Ekspor) ---
        window.renderSettings = () => {
            const { settings } = window.appState;
            const logoPreview = settings.logoUrl 
                ? `<img src="${settings.logoUrl}" alt="Logo Toko" class="w-16 h-16 object-contain rounded-full border-2 border-cyan-500 p-1 mb-2">` 
                : '<div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center text-gray-500 mb-2">LOGO</div>';

            return `
                <div class="pb-6">
                    <h2 class="text-2xl font-extrabold text-gray-800 mb-6">Pengaturan Toko & Data</h2>

                    <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-200 mb-6">
                        <h3 class="text-xl font-bold text-cyan-600 mb-4 flex items-center space-x-2">
                            <span>üè†</span> <span>Informasi Toko</span>
                        </h3>
                        <form id="store-settings-form" onsubmit="window.saveSettings(event)">
                            <div class="mb-4">
                                ${logoPreview}
                                <label for="logo-upload" class="block text-sm font-medium text-gray-700">Logo Toko (Unggah File)</label>
                                <input type="file" id="logo-upload" accept="image/*" onchange="window.handleLogoUpload(event)" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-cyan-50 file:text-cyan-700 hover:file:bg-cyan-100">
                                ${settings.logoUrl ? `<button type="button" onclick="window.removeLogo()" class="text-red-500 text-xs mt-2">Hapus Logo</button>` : ''}
                            </div>
                            <div class="mb-4">
                                <label for="store-name" class="block text-sm font-medium text-gray-700">Nama Toko</label>
                                <input type="text" id="store-name" value="${settings.storeName || ''}" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-cyan-500 focus:border-cyan-500">
                            </div>
                            <div class="mb-4">
                                <label for="cashier-name" class="block text-sm font-medium text-gray-700">Nama Kasir</label>
                                <input type="text" id="cashier-name" value="${settings.cashierName || ''}" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-cyan-500 focus:border-cyan-500">
                            </div>
                            <div class="mb-4">
                                <label for="address" class="block text-sm font-medium text-gray-700">Alamat</label>
                                <textarea id="address" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-cyan-500 focus:border-cyan-500">${settings.address || ''}</textarea>
                            </div>
                            <button type="submit" class="w-full py-3 bg-cyan-600 text-white font-semibold rounded-lg shadow-lg hover:bg-cyan-700 transition duration-150">
                                Simpan Pengaturan
                            </button>
                        </form>
                    </div>

                    <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-200 mb-6">
                        <h3 class="text-xl font-bold text-green-600 mb-4 flex items-center space-x-2">
                            <span>üì§üì•</span> <span>Impor & Ekspor Data (Backup)</span>
                        </h3>
                        <div class="space-y-3">
                            <button onclick="window.exportAllDataJson()" class="w-full py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700">
                                üíæ Ekspor Semua Data (JSON Backup)
                            </button>
                            <label for="import-file" class="w-full block py-3 text-center bg-yellow-500 text-white font-semibold rounded-lg hover:bg-yellow-600 cursor-pointer">
                                ‚¨ÜÔ∏è Impor Semua Data (JSON Restore)
                            </label>
                            <input type="file" id="import-file" accept=".json" onchange="window.importAllDataJson(event)" class="hidden">
                            <button onclick="window.exportToCsv('products')" class="w-full py-2 bg-gray-500 text-white text-sm rounded-lg hover:bg-gray-600">
                                Ekspor Daftar Produk (CSV)
                            </button>
                            <button onclick="window.exportToCsv('transactions')" class="w-full py-2 bg-gray-500 text-white text-sm rounded-lg hover:bg-gray-600">
                                Ekspor Riwayat Transaksi (CSV)
                            </button>
                        </div>
                    </div>

                    <div class="bg-white p-5 rounded-xl shadow-lg border border-red-300 mb-6">
                        <h3 class="text-xl font-bold text-red-600 mb-4 flex items-center space-x-2">
                            <span>‚ö†Ô∏è</span> <span>Hapus Semua Data</span>
                        </h3>
                        <p class="text-sm text-gray-600 mb-3">Ini akan menghapus **semua** data dari browser Anda.</p>
                        <button onclick="window.confirmDeleteAllData()" class="w-full py-3 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150">
                            HAPUS SEMUA DATA PERMANEN
                        </button>
                    </div>
                </div>
            `;
        };

        // --- Logic Impor/Ekspor Data Base ---

        window.downloadFile = (data, filename, type) => {
            const blob = new Blob([data], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        // 1. Export JSON (Backup Lengkap)
        window.exportAllDataJson = () => {
            const dataToExport = {
                settings: window.appState.settings,
                products: window.appState.products,
                transactions: window.appState.transactions,
                pettyCash: window.appState.pettyCash,
            };
            const jsonString = JSON.stringify(dataToExport, null, 2);
            const filename = `arkasir_backup_${new Date().toISOString().split('T')[0]}.json`;
            
            window.downloadFile(jsonString, filename, 'application/json');
            window.showModal('Sukses Ekspor', `File backup <b>${filename}</b> berhasil diunduh!`);
        };

        // 2. Import JSON (Restore Lengkap)
        window.importAllDataJson = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (!importedData.products || !importedData.transactions) {
                        throw new Error('Format JSON tidak valid.');
                    }

                    // Terapkan data yang diimpor
                    window.appState.settings = { ...window.appState.settings, ...importedData.settings };
                    window.appState.products = importedData.products;
                    window.appState.transactions = importedData.transactions;
                    window.appState.pettyCash = importedData.pettyCash || []; // Tambahkan fallback
                    
                    saveToLocalStorage();
                    window.showModal('Sukses Impor', `Data berhasil diimpor dan aplikasi di-restore!`);
                    renderApp();

                } catch (error) {
                    console.error("Error importing data:", error);
                    window.showModal('Error Impor', `Gagal mengimpor data: ${error.message}. Pastikan file JSON valid.`);
                }
            };
            reader.readAsText(file);
        };

        // 3. Export CSV
        window.convertToCsv = (dataArray, headers) => {
            if (dataArray.length === 0) return '';
            
            const csvRows = [];
            // Header
            csvRows.push(headers.join(','));
            
            // Data
            for (const item of dataArray) {
                const values = headers.map(header => {
                    let value = item[header] || '';

                    // Khusus untuk transaksi, flatten items
                    if (header === 'items') {
                        value = item.items.map(i => `${i.name} (${i.quantity}x)`).join(';');
                    } 
                    
                    // Format timestamp
                    else if (header === 'timestamp') {
                        value = new Date(item.timestamp).toISOString();
                    }

                    // Escape quotes and ensure proper CSV format
                    if (typeof value === 'string') {
                        value = value.replace(/"/g, '""'); // Escape double quotes
                        if (value.includes(',') || value.includes('\n') || value.includes('"')) {
                            value = `"${value}"`; // Quote the field if it contains special chars
                        }
                    }
                    return value;
                });
                csvRows.push(values.join(','));
            }
            
            return csvRows.join('\n');
        };

        window.exportToCsv = (dataType) => {
            let dataArray;
            let headers;
            let filename;

            if (dataType === 'products') {
                dataArray = window.appState.products;
                headers = ['id', 'name', 'price', 'barcode'];
                filename = `produk_${new Date().toISOString().split('T')[0]}.csv`;
            } else if (dataType === 'transactions') {
                dataArray = window.appState.transactions;
                headers = ['id', 'timestamp', 'total', 'paid', 'change', 'cashierName', 'items'];
                filename = `transaksi_${new Date().toISOString().split('T')[0]}.csv`;
            } else {
                return window.showModal('Error', 'Tipe data ekspor tidak valid.');
            }

            if (dataArray.length === 0) {
                 return window.showModal('Informasi', `Data ${dataType} masih kosong.`);
            }

            const csvData = window.convertToCsv(dataArray, headers);
            window.downloadFile(csvData, filename, 'text/csv;charset=utf-8;');
            window.showModal('Sukses Ekspor', `File CSV <b>${filename}</b> berhasil diunduh!`);
        };


        // --- Logic Lain (Logo, Reset, PNG Export) ---
        
        window.handleLogoUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                window.appState.settings.logoUrl = e.target.result; 
                saveToLocalStorage();
                renderApp();
                window.showModal('Sukses', 'Logo berhasil diunggah secara lokal!');
            };
            reader.readAsDataURL(file);
        };

        window.removeLogo = () => {
            window.appState.settings.logoUrl = '';
            saveToLocalStorage();
            renderApp();
            window.showModal('Sukses', 'Logo berhasil dihapus.');
        };

        window.saveSettings = (event) => {
            event.preventDefault();
            
            const newSettings = {
                storeName: document.getElementById('store-name').value.trim(),
                cashierName: document.getElementById('cashier-name').value.trim(),
                address: document.getElementById('address').value.trim(),
                logoUrl: window.appState.settings.logoUrl, 
            };

            window.appState.settings = { ...window.appState.settings, ...newSettings };
            saveToLocalStorage();
            
            window.showModal('Sukses', 'Pengaturan toko berhasil disimpan!');
            renderApp();
        };

        window.confirmDeleteAllData = () => {
             window.showModal('PERINGATAN! Hapus Semua Data', `
                 <p class="text-red-700 font-bold mb-4">Anda yakin ingin menghapus SEMUA data aplikasi?</p>
                 <p class="text-sm text-gray-700 mb-4">Pastikan Anda sudah melakukan **Ekspor Data (JSON Backup)** sebelum melanjutkan. Tindakan ini PERMANEN!</p>
                 <div class="flex justify-end space-x-3">
                     <button onclick="window.closeModal()" class="py-2 px-4 bg-gray-200 rounded-lg">Batal</button>
                     <button onclick="window.deleteAllData()" class="py-2 px-4 bg-red-600 text-white font-bold rounded-lg">YA, HAPUS SEMUA</button>
                 </div>
             `, false);
        }

        window.deleteAllData = () => {
            window.closeModal();

            try {
                window.showModal('Memproses', '<p class="text-center">Sedang menghapus data. Mohon tunggu...</p>', false);

                localStorage.removeItem('arkasir_settings');
                localStorage.removeItem('arkasir_products');
                localStorage.removeItem('arkasir_transactions');
                localStorage.removeItem('arkasir_pettyCash');
                
                window.appState.settings = DEFAULT_SETTINGS;
                window.appState.products = DEFAULT_PRODUCTS;
                window.appState.transactions = [];
                window.appState.pettyCash = [];
                window.appState.cart = [];
                
                setTimeout(() => {
                    window.showModal('Sukses!', 'Semua data aplikasi telah dihapus dan direset ke kondisi awal.');
                    window.navigate('Settings');
                }, 500); 
                
            } catch (error) {
                console.error("Error deleting all data:", error);
                window.showModal('Error', `Gagal menghapus data: ${error.message}.`);
            }
        };

        window.downloadElementAsPng = (element, filename) => {
            html2canvas(element, { scale: 3, useCORS: true }).then(canvas => {
                const link = document.createElement('a');
                link.download = `${filename}_${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL('image/png');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.showModal('Sukses', `File <b>${filename}.png</b> berhasil disimpan.`);
            }).catch(error => {
                console.error('Error generating PNG:', error);
                window.showModal('Error', `Gagal membuat PNG. Coba lagi: ${error.message}`);
            });
        };
        
        window.downloadReportPng = (elementId, reportTitle) => {
            const element = document.getElementById(elementId);
            if (!element) return window.showModal('Error', 'Konten laporan tidak ditemukan.');

            const downloadButton = element.querySelector('button');
            if(downloadButton) downloadButton.style.display = 'none';

            window.downloadElementAsPng(element, reportTitle.toLowerCase().replace(/\s/g, '_'));

            if(downloadButton) downloadButton.style.display = 'flex';
        };


        // --- Render Utama Aplikasi ---
        window.renderApp = () => {
            const contentArea = document.getElementById('content-area');
            let contentHtml = '';

            switch (window.appState.currentPage) {
                case 'POS': contentHtml = window.renderPOS(); break;
                case 'Reports': contentHtml = window.renderReports(); break;
                case 'Settings': contentHtml = window.renderSettings(); break;
                case 'PettyCash': contentHtml = window.renderPettyCash(); break;
                case 'Products': contentHtml = window.renderProducts(); break;
                default: contentHtml = `<div class="p-4 text-center text-red-500">Halaman tidak ditemukan.</div>`;
            }

            contentArea.innerHTML = contentHtml;

            // Update Navigasi Aktif
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('text-cyan-600', 'font-bold'));
            const activeIndex = ['POS', 'PettyCash', 'Reports', 'Products'].indexOf(window.appState.currentPage);
            if (activeIndex !== -1) {
                document.querySelector(`.nav-btn:nth-child(${activeIndex + 1})`).classList.add('text-cyan-600', 'font-bold');
            }

            // Set fokus ke input barcode jika di halaman POS
            if (window.appState.currentPage === 'POS') {
                setTimeout(() => document.getElementById('barcode-input')?.focus(), 100);
            }
        };

        window.onload = () => {
            window.renderApp();
        };
    </script>
</body>
</html>
